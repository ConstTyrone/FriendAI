<!--
  å…³ç³»å›¾è°±å¯è§†åŒ–ç»„ä»¶
  æ”¯æŒè§¦æ‘¸äº¤äº’ã€èŠ‚ç‚¹é€‰æ‹©ã€ç¼©æ”¾å’Œæ‹–æ‹½
-->
<view class="relationship-graph">
  <!-- å·¥å…·æ  -->
  <view class="graph-toolbar">
    <view class="toolbar-left">
      <t-button 
        variant="text" 
        size="small" 
        icon="refresh"
        bind:tap="onRefresh"
      >åˆ·æ–°</t-button>
      
      <t-button 
        variant="text" 
        size="small" 
        icon="setting"
        bind:tap="onOpenSettings"
      >è®¾ç½®</t-button>
    </view>
    
    <view class="toolbar-right">
      <t-button 
        variant="text" 
        size="small" 
        icon="zoom-in"
        bind:tap="onZoomIn"
      >æ”¾å¤§</t-button>
      
      <t-button 
        variant="text" 
        size="small" 
        icon="zoom-out"
        bind:tap="onZoomOut"
      >ç¼©å°</t-button>
      
      <t-button 
        variant="text" 
        size="small" 
        icon="location"
        bind:tap="onResetView"
      >å±…ä¸­</t-button>
      
      <t-button 
        variant="text" 
        size="small" 
        icon="fullscreen"
        bind:tap="onFullscreen"
      >å…¨å±</t-button>
    </view>
  </view>
  
  <!-- å›¾è°±ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="graph-stats" wx:if="{{showStats && graphData.stats}}">
    <view class="stat-item">
      <text class="stat-number">{{graphData.stats.totalNodes}}</text>
      <text class="stat-label">è”ç³»äºº</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{graphData.stats.totalLinks}}</text>
      <text class="stat-label">å…³ç³»</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{graphData.stats.confirmedLinks}}</text>
      <text class="stat-label">å·²ç¡®è®¤</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{graphData.stats.strongLinks}}</text>
      <text class="stat-label">å¼ºå…³ç³»</text>
    </view>
  </view>
  
  <!-- å›¾è°±ç”»å¸ƒ -->
  <view class="graph-canvas-container">
    <canvas 
      class="graph-canvas"
      canvas-id="relationshipGraph"
      type="2d"
      style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
      bind:touchstart="onTouchStart"
      bind:touchmove="onTouchMove"
      bind:touchend="onTouchEnd"
      bind:tap="onCanvasTap"
      disable-scroll="{{true}}"
    ></canvas>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-overlay" wx:if="{{loading}}">
      <t-loading theme="dots" size="large" text="æ­£åœ¨ç”Ÿæˆå…³ç³»å›¾è°±..." />
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && (!graphData.nodes || graphData.nodes.length === 0)}}">
      <t-icon name="link-unlink" size="large" color="var(--td-text-color-placeholder)" />
      <text class="empty-text">æš‚æ— å…³ç³»æ•°æ®</text>
      <text class="empty-tip">æ·»åŠ è”ç³»äººåç³»ç»Ÿä¼šè‡ªåŠ¨å‘ç°å…³ç³»</text>
    </view>
  </view>
  
  <!-- å›¾ä¾‹ -->
  <view class="graph-legend" wx:if="{{showLegend && graphData.stats.relationshipTypes.length > 0}}">
    <view class="legend-title">å…³ç³»ç±»å‹</view>
    <scroll-view class="legend-content" scroll-x>
      <view class="legend-items">
        <view 
          class="legend-item" 
          wx:for="{{graphData.stats.relationshipTypes}}" 
          wx:key="type"
          wx:if="{{index < 6}}"
        >
          <view 
            class="legend-color" 
            style="background-color: {{getLinkColor(item.type)}}"
          ></view>
          <text class="legend-text">{{getRelationshipTypeName(item.type)}} ({{item.count}})</text>
        </view>
      </view>
    </scroll-view>
    
    <!-- äº¤äº’æç¤º -->
    <view class="interaction-tips">
      <view class="tips-title">ğŸ’¡ æ“ä½œæç¤º</view>
      <view class="tips-list">
        <view class="tip-item">ğŸ‘† ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</view>
        <view class="tip-item">ğŸ‘† ç‚¹å‡»è¿çº¿æŸ¥çœ‹å…³ç³»</view>
        <view class="tip-item">ğŸ” åŒæŒ‡ç¼©æ”¾æŸ¥çœ‹æ›´å¤š</view>
        <view class="tip-item">âš™ï¸ ç‚¹å‡»è®¾ç½®è°ƒæ•´æ˜¾ç¤º</view>
      </view>
    </view>
  </view>
  
  <!-- èŠ‚ç‚¹è¯¦æƒ…å¼¹çª— -->
  <t-popup
    visible="{{showNodeDetail}}"
    placement="bottom"
    bind:visible-change="onNodeDetailClose"
  >
    <view class="node-detail-popup" wx:if="{{selectedNode}}">
      <view class="node-detail-header">
        <t-avatar 
          size="large" 
          image="{{selectedNode.avatar}}" 
        >{{selectedNode.name.charAt(0)}}</t-avatar>
        <view class="node-detail-info">
          <view class="node-name">{{selectedNode.name}}</view>
          <view class="node-company">{{selectedNode.company}}</view>
          <view class="node-position">{{selectedNode.position}}</view>
        </view>
        <t-button 
          variant="text" 
          icon="close" 
          bind:tap="onNodeDetailClose"
        ></t-button>
      </view>
      
      <view class="node-detail-stats">
        <view class="detail-stat">
          <text class="stat-number">{{selectedNode.relationshipCount}}</text>
          <text class="stat-label">æ€»å…³ç³»æ•°</text>
        </view>
        <view class="detail-stat">
          <text class="stat-number">{{selectedNode.strongRelationshipCount}}</text>
          <text class="stat-label">å¼ºå…³ç³»æ•°</text>
        </view>
        <view class="detail-stat">
          <text class="stat-number">{{selectedNode.level}}</text>
          <text class="stat-label">å…³ç³»å±‚çº§</text>
        </view>
      </view>
      
      <view class="node-detail-tags" wx:if="{{selectedNode.tags && selectedNode.tags.length > 0}}">
        <view class="tags-title">æ ‡ç­¾</view>
        <view class="tags-list">
          <t-tag 
            variant="light" 
            size="small"
            wx:for="{{selectedNode.tags}}" 
            wx:key="*this"
          >{{item}}</t-tag>
        </view>
      </view>
      
      <view class="node-detail-actions">
        <t-button 
          variant="outline" 
          size="small"
          bind:tap="onViewNodeDetail"
        >æŸ¥çœ‹è¯¦æƒ…</t-button>
        <t-button 
          theme="primary" 
          size="small"
          bind:tap="onSetAsCenter"
        >è®¾ä¸ºä¸­å¿ƒ</t-button>
      </view>
    </view>
  </t-popup>
  
  <!-- å…³ç³»è¯¦æƒ…å¼¹çª— -->
  <t-popup
    visible="{{showLinkDetail}}"
    placement="bottom" 
    bind:visible-change="onLinkDetailClose"
  >
    <view class="link-detail-popup" wx:if="{{selectedLink}}">
      <view class="link-detail-header">
        <view class="link-title">
          {{getLinkSourceName(selectedLink)}} â†” {{getLinkTargetName(selectedLink)}}
        </view>
        <t-button 
          variant="text" 
          icon="close" 
          bind:tap="onLinkDetailClose"
        ></t-button>
      </view>
      
      <view class="link-detail-content">
        <view class="detail-row">
          <text class="detail-label">å…³ç³»ç±»å‹:</text>
          <text class="detail-value">{{getRelationshipTypeName(selectedLink.type)}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">å…³ç³»å¼ºåº¦:</text>
          <text class="detail-value">{{getRelationshipStrengthName(selectedLink.strength)}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">ç½®ä¿¡åº¦:</text>
          <text class="detail-value">{{formatConfidence(selectedLink.confidence)}}%</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">çŠ¶æ€:</text>
          <t-tag 
            variant="{{selectedLink.confirmed ? 'dark' : 'light'}}"
            theme="{{selectedLink.confirmed ? 'success' : 'warning'}}"
            size="small"
          >
            {{selectedLink.confirmed ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤'}}
          </t-tag>
        </view>
        <view class="detail-row" wx:if="{{selectedLink.matchedFields && selectedLink.matchedFields.length > 0}}">
          <text class="detail-label">åŒ¹é…å­—æ®µ:</text>
          <text class="detail-value">{{selectedLink.matchedFields.join(', ')}}</text>
        </view>
      </view>
      
      <view class="link-detail-actions" wx:if="{{!selectedLink.confirmed}}">
        <t-button 
          variant="outline" 
          size="small"
          bind:tap="onIgnoreLink"
        >å¿½ç•¥å…³ç³»</t-button>
        <t-button 
          theme="primary" 
          size="small"
          bind:tap="onConfirmLink"
        >ç¡®è®¤å…³ç³»</t-button>
      </view>
    </view>
  </t-popup>
  
  <!-- è®¾ç½®å¼¹çª— -->
  <t-popup
    visible="{{showSettings}}"
    placement="bottom"
    bind:visible-change="onSettingsClose"
  >
    <view class="settings-popup">
      <view class="settings-header">
        <text class="settings-title">å›¾è°±è®¾ç½®</text>
        <t-button 
          variant="text" 
          icon="close" 
          bind:tap="onSettingsClose"
        ></t-button>
      </view>
      
      <view class="settings-content">
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</text>
          <t-switch 
            value="{{showStats}}" 
            bind:change="onShowStatsChange"
          ></t-switch>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºå›¾ä¾‹</text>
          <t-switch 
            value="{{showLegend}}" 
            bind:change="onShowLegendChange"
          ></t-switch>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">å¸ƒå±€æ–¹å¼</text>
          <t-radio-group 
            value="{{layoutType}}" 
            bind:change="onLayoutTypeChange"
          >
            <t-radio value="circle" label="ç¯å½¢å¸ƒå±€" />
            <t-radio value="radial" label="å¾„å‘å¸ƒå±€" />
          </t-radio-group>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">æœ€å°ç½®ä¿¡åº¦</text>
          <t-slider 
            value="{{minConfidence * 100}}"
            min="0"
            max="100" 
            step="10"
            bind:change="onMinConfidenceChange"
          ></t-slider>
          <text class="setting-value">{{formatMinConfidence(minConfidence)}}%</text>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">æœ€å¤§å±‚çº§</text>
          <t-stepper 
            value="{{maxDepth}}"
            min="1"
            max="5"
            bind:change="onMaxDepthChange"
          ></t-stepper>
        </view>
      </view>
    </view>
  </t-popup>
</view>
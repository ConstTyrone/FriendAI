# 企微客服消息绑定方案

## 当前实现方案

由于企微客服URL不支持自定义参数传递，我们采用**通过客服消息传递验证码**的方式来完成用户绑定。

## 前端流程

### 1. 用户触发绑定
用户登录小程序后，如果未绑定企微账户，会自动跳转到绑定页面。

### 2. 生成验证码
系统生成一个6位数字验证码（如：`123456`），方便用户输入。

### 3. 显示操作指引
```
1. 复制验证码：123456
2. 打开企微客服
3. 在对话中发送验证码
```

### 4. 状态检查
小程序在后台每2秒轮询一次绑定状态，最多检查30次（60秒）。

### 5. 绑定完成
后端收到验证码后完成绑定，小程序检测到状态变更后自动跳转到联系人列表。

## 后端流程

### 1. 创建绑定会话
```python
POST /api/binding/create-session
{
    "openid": "用户openid"
}

返回：
{
    "success": true,
    "token": "绑定会话token",
    "verify_code": "123456",  # 6位验证码
    "expires_in": 300
}
```

### 2. 接收企微客服消息
```python
@app.post("/api/wechat-work/message")
async def handle_customer_message(request: Request):
    """处理企微客服消息"""
    message = parse_wechat_work_message(request)
    
    # 如果消息是6位数字
    if re.match(r'^\d{6}$', message.content):
        verify_code = message.content
        external_userid = message.external_userid
        
        # 通过验证码查找绑定会话
        bind_token = redis_client.get(f"verify_code:{verify_code}")
        if bind_token:
            # 完成绑定
            complete_binding(bind_token, external_userid)
            
            # 回复用户
            send_kf_message(external_userid, "绑定成功！请返回小程序查看。")
```

### 3. 检查绑定状态
```python
GET /api/binding/check-status?token=xxx

返回：
{
    "status": "bound",  # pending/bound/expired/failed
    "external_userid": "xxx"  # 绑定成功时返回
}
```

## 数据库设计

### user_binding 表
```sql
CREATE TABLE user_binding (
    id INT PRIMARY KEY AUTO_INCREMENT,
    openid VARCHAR(64) UNIQUE NOT NULL,
    external_userid VARCHAR(64) UNIQUE,
    verify_code VARCHAR(10),
    bind_status TINYINT DEFAULT 0,
    bind_time DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_openid (openid),
    INDEX idx_external_userid (external_userid),
    INDEX idx_verify_code (verify_code)
);
```

## Redis缓存结构

```
# 绑定会话
bind_session:{token} = {
    "openid": "xxx",
    "verify_code": "123456",
    "status": "pending",
    "created_at": "2024-01-01T10:00:00"
}

# 验证码映射
verify_code:{code} = {token}
```

## 用户体验优化

### 1. 简化验证码
- 使用6位纯数字，避免大小写混淆
- 自动复制到剪贴板
- 清晰显示在页面上

### 2. 清晰的操作指引
- 分步骤说明操作流程
- 实时显示检查进度
- 提供手动刷新功能

### 3. 多种打开方式
- 小程序内webview打开（如果配置了业务域名）
- 复制链接到浏览器打开
- 显示二维码扫描（可选）

### 4. 异常处理
- 超时自动提示重试
- Token过期提示重新登录
- 网络错误友好提示

## 安全考虑

1. **验证码有效期**：5分钟内有效，过期自动清除
2. **防重复绑定**：同一openid只能绑定一次
3. **防暴力破解**：限制验证码尝试次数
4. **数据加密**：敏感数据加密存储

## 部署注意事项

1. **企微配置**
   - 配置企微客服消息接收URL
   - 设置消息加解密Token
   - 配置IP白名单

2. **小程序配置**
   - 如需webview，配置业务域名
   - 配置request合法域名

3. **后端要求**
   - Redis用于会话管理
   - MySQL存储绑定关系
   - 实现企微消息接收接口

## 测试流程

1. 使用测试账号登录小程序
2. 触发绑定流程，获取验证码
3. 打开企微客服，发送验证码
4. 验证绑定状态更新
5. 确认能正常获取用户数据

## 后续优化方向

1. **自动化绑定**：通过企微API自动获取用户信息
2. **批量绑定**：支持管理员批量导入绑定关系
3. **解绑功能**：用户可以主动解除绑定
4. **多账号管理**：支持一个用户绑定多个企微账号
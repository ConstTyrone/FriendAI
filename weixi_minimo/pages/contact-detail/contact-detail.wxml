<!--è”ç³»äººè¯¦æƒ…é¡µé¢-->
<view class="detail-page {{themeClass}}">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-state" wx:if="{{error && !loading}}">
    <text class="error-message">{{error}}</text>
    <view class="error-action" bind:tap="initPageData">
      <text class="action-text">é‡æ–°åŠ è½½</text>
    </view>
  </view>

  <!-- è”ç³»äººè¯¦æƒ…å†…å®¹ -->
  <view class="detail-content" wx:if="{{contactInfo && !loading && !error}}">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="header-section">
      <!-- å³ä¸Šè§’ç”µè¯æŒ‰é’® -->
      <view class="header-phone-btn" wx:if="{{contactInfo.phone}}" bind:tap="onCallPhone">
        <text class="phone-icon">ğŸ“</text>
      </view>
      
      <view class="header-avatar">
        <text class="avatar-text">{{contactInfo.initial}}</text>
      </view>
      
      <view class="header-info">
        <text class="header-name">{{contactInfo.profile_name || contactInfo.name || 'æœªçŸ¥'}}</text>
        <text class="header-company" wx:if="{{contactInfo.company}}">
          {{contactInfo.company}}
        </text>
        <text class="header-position" wx:if="{{contactInfo.position}}">
          {{contactInfo.position}}
        </text>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.phone}}">
          <text class="info-label">ç”µè¯</text>
          <text class="info-value">{{contactInfo.phone}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.gender}}">
          <text class="info-label">æ€§åˆ«</text>
          <text class="info-value">{{contactInfo.gender}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.age}}">
          <text class="info-label">å¹´é¾„</text>
          <text class="info-value">{{contactInfo.age}}</text>
        </view>
      </view>
    </view>

    <!-- å·¥ä½œä¿¡æ¯ -->
    <view 
      class="info-section"
      wx:if="{{contactInfo.company || contactInfo.position}}"
    >
      <text class="section-title">å·¥ä½œä¿¡æ¯</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.company}}">
          <text class="info-label">å…¬å¸</text>
          <text class="info-value">{{contactInfo.company}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.position}}">
          <text class="info-label">èŒåŠ¡</text>
          <text class="info-value">{{contactInfo.position}}</text>
        </view>
      </view>
    </view>

    <!-- AIæè¿° -->
    <view 
      class="info-section ai-section"
      wx:if="{{contactInfo.ai_summary}}"
    >
      <text class="section-title">AIæè¿°</text>
      <view class="ai-content">
        <text class="ai-text">{{contactInfo.ai_summary}}</text>
      </view>
    </view>

    <!-- å…³ç³»ä¿¡æ¯ -->
    <view class="info-section relationship-section">
      <view class="section-header" bind:tap="onViewAllRelationships">
        <text class="section-title">å…³ç³»å‘ç°</text>
        <view class="section-action">
          <text class="action-text" wx:if="{{relationshipStats.total > 0}}">æŸ¥çœ‹å…¨éƒ¨ ({{relationshipStats.total}})</text>
          <text class="action-text" wx:else>æš‚æ— å…³ç³»</text>
          <text class="action-arrow">â€º</text>
        </view>
      </view>

      <!-- å…³ç³»ç»Ÿè®¡ -->
      <view class="relationship-stats" wx:if="{{relationshipStats.total > 0}}">
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.confirmed}}</text>
          <text class="stat-label">å·²ç¡®è®¤</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.discovered}}</text>
          <text class="stat-label">å¾…ç¡®è®¤</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.total}}</text>
          <text class="stat-label">æ€»å…³ç³»</text>
        </view>
      </view>

      <!-- å…³ç³»é¢„è§ˆ -->
      <view class="relationship-preview" wx:if="{{recentRelationships.length > 0}}">
        <view wx:for="{{recentRelationships}}" wx:key="id" class="relationship-preview-item" bind:tap="onViewRelationshipDetail" data-relationship-id="{{item.id}}">
          <view class="preview-avatar">
            <text class="preview-avatar-text">{{item.otherInitial}}</text>
          </view>
          <view class="preview-info">
            <text class="preview-name">{{item.otherName}}</text>
            <view class="preview-meta">
              <text class="preview-relation">{{item.relationshipLabel}}</text>
              <text class="preview-confidence" wx:if="{{item.confidenceScore > 0}}">{{item.confidenceScore}}%</text>
            </view>
          </view>
          <view class="preview-status {{item.status}}">
            <text class="status-text">{{item.statusLabel}}</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="relationship-empty" wx:if="{{relationshipStats.total === 0}}">
        <view class="empty-icon">
          <text class="icon-text">ğŸ”—</text>
        </view>
        <text class="empty-desc">æš‚æœªå‘ç°ç›¸å…³å…³ç³»ï¼Œç³»ç»Ÿä¼šæŒç»­åˆ†æ</text>
        <view class="empty-action" bind:tap="onAnalyzeRelationships">
          <text class="action-text">ç«‹å³åˆ†æ</text>
        </view>
      </view>
    </view>

    <!-- ä¿¡æ¯æ¥æº -->
    <view 
      class="info-section source-section" 
      wx:if="{{contactInfo.source_messages && contactInfo.source_messages.length > 0}}"
    >
      <view class="section-header" bind:tap="onToggleSourceMessages">
        <text class="section-title">åŸå§‹æ¶ˆæ¯è®°å½• ({{contactInfo.source_messages.length}}æ¡)</text>
        <view class="section-action">
          <text class="action-arrow {{showSourceMessages ? 'expanded' : ''}}">â€º</text>
        </view>
      </view>
      
      <view class="source-messages {{showSourceMessages ? 'expanded' : ''}}" wx:if="{{showSourceMessages}}">
        <view wx:for="{{contactInfo.source_messages}}" wx:key="id" class="message-item">
          <view class="message-header">
            <text class="message-type">{{item.message_type}}</text>
            <text class="message-time">{{formatSourceTime(item.timestamp)}}</text>
          </view>
          
          <view class="message-content" wx:if="{{item.processed_content}}">
            <text class="content-label">å¤„ç†åå†…å®¹ï¼š</text>
            <text class="content-text">{{item.processed_content}}</text>
          </view>
          
          <view class="message-meta" wx:if="{{item.wechat_msg_id || item.media_url}}">
            <text class="meta-label">æ¶ˆæ¯è¯¦æƒ…ï¼š</text>
            <text class="meta-text" wx:if="{{item.wechat_msg_id}}">æ¶ˆæ¯ID: {{item.wechat_msg_id}}</text>
            <text class="meta-text" wx:if="{{item.media_url}}">åª’ä½“URL: {{item.media_url}}</text>
          </view>
          
          <view class="message-action">
            <text class="action-label">{{item.action === 'created' ? 'é¦–æ¬¡åˆ›å»º' : 'ä¿¡æ¯æ›´æ–°'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´ä¿¡æ¯ -->
    <view class="time-info">
      <text class="time-text">åˆ›å»ºäº {{formatDate(contactInfo.created_at)}}</text>
      <text class="time-text" wx:if="{{contactInfo.updated_at}}">æ›´æ–°äº {{formatDate(contactInfo.updated_at)}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{contactInfo && !loading && !error}}">
    <view class="bar-button" bind:tap="onViewAllRelationships">
      <text class="bar-text">å…³ç³»</text>
      <view class="button-badge" wx:if="{{relationshipStats.discovered > 0}}">
        <text class="badge-text">{{relationshipStats.discovered}}</text>
      </view>
    </view>
    <view class="bar-button" bind:tap="onEditContact">
      <text class="bar-text">ç¼–è¾‘</text>
    </view>
    <view class="bar-button delete" bind:tap="onDeleteContact">
      <text class="bar-text">åˆ é™¤</text>
    </view>
  </view>

  <!-- åˆ é™¤ç¡®è®¤ -->
  <view class="confirm-overlay {{showDeleteDialog ? 'show' : ''}}" bind:tap="onCancelDelete">
    <view class="confirm-dialog" catch:tap="onStopPropagation">
      <text class="confirm-title">ç¡®è®¤åˆ é™¤</text>
      <text class="confirm-message">åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</text>
      <view class="confirm-actions">
        <view class="confirm-button cancel" bind:tap="onCancelDelete">
          <text class="button-text">å–æ¶ˆ</text>
        </view>
        <view class="confirm-button delete" bind:tap="onConfirmDelete">
          <text class="button-text">åˆ é™¤</text>
        </view>
      </view>
    </view>
  </view>
</view>
<!--è”ç³»äººè¯¦æƒ…é¡µé¢-->
<view class="detail-page {{themeClass}}">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-state" wx:if="{{error && !loading}}">
    <text class="error-message">{{error}}</text>
    <view class="error-action" bind:tap="initPageData">
      <text class="action-text">é‡æ–°åŠ è½½</text>
    </view>
  </view>

  <!-- è”ç³»äººè¯¦æƒ…å†…å®¹ -->
  <view class="detail-content" wx:if="{{contactInfo && !loading && !error}}">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="header-section">
      <!-- å³ä¸Šè§’ç”µè¯æŒ‰é’® -->
      <view class="header-phone-btn" wx:if="{{contactInfo.phone}}" bind:tap="onCallPhone">
        <text class="phone-icon">ğŸ“</text>
      </view>
      
      <view class="header-avatar">
        <text class="avatar-text">{{contactInfo.initial}}</text>
      </view>
      
      <view class="header-info">
        <text class="header-name">{{contactInfo.profile_name || contactInfo.name || 'æœªçŸ¥'}}</text>
        <text class="header-company" wx:if="{{contactInfo.company}}">
          {{contactInfo.company}}
        </text>
        <text class="header-position" wx:if="{{contactInfo.position}}">
          {{contactInfo.position}}
        </text>
      </view>
    </view>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <view class="quick-actions">
      <view class="action-button" bind:tap="onCopyWechatId" wx:if="{{contactInfo.wechat_id}}">
        <text class="action-label">å¾®ä¿¡</text>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.phone}}">
          <text class="info-label">ç”µè¯</text>
          <text class="info-value">{{formatPhone(contactInfo.phone)}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.wechat_id}}" bind:tap="onCopyWechatId">
          <text class="info-label">å¾®ä¿¡</text>
          <text class="info-value">{{contactInfo.wechat_id}}</text>
          <text class="info-arrow">â€º</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.email}}">
          <text class="info-label">é‚®ç®±</text>
          <text class="info-value">{{contactInfo.email}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.location || contactInfo.address}}">
          <text class="info-label">åœ°å€</text>
          <text class="info-value">{{contactInfo.location || contactInfo.address}}</text>
        </view>
      </view>
    </view>

    <!-- ä¸ªäººç‰¹å¾ -->
    <view 
      class="info-section"
      wx:if="{{contactInfo.gender || contactInfo.age || contactInfo.marital_status || contactInfo.education || contactInfo.asset_level}}"
    >
      <text class="section-title">ä¸ªäººç‰¹å¾</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.gender}}">
          <text class="info-label">æ€§åˆ«</text>
          <text class="info-value">{{contactInfo.gender}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.age}}">
          <text class="info-label">å¹´é¾„</text>
          <text class="info-value">{{contactInfo.age}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.marital_status}}">
          <text class="info-label">å©šå§»</text>
          <text class="info-value">{{contactInfo.marital_status}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.education}}">
          <text class="info-label">å­¦å†</text>
          <text class="info-value">{{contactInfo.education}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.asset_level}}">
          <text class="info-label">èµ„äº§</text>
          <text class="info-value">{{contactInfo.asset_level}}</text>
        </view>
      </view>
    </view>

    <!-- AIåˆ†æ -->
    <view 
      class="info-section ai-section"
      wx:if="{{contactInfo.ai_summary || contactInfo.personality}}"
    >
      <text class="section-title">AIåˆ†æ</text>
      <view class="ai-content">
        <view class="ai-item" wx:if="{{contactInfo.ai_summary}}">
          <text class="ai-text">{{contactInfo.ai_summary}}</text>
        </view>
        <view class="ai-item" wx:if="{{contactInfo.personality}}">
          <text class="ai-label">æ€§æ ¼ï¼š</text>
          <text class="ai-text">{{contactInfo.personality}}</text>
        </view>
      </view>
    </view>

    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    <view class="info-section" wx:if="{{contactInfo.notes}}">
      <text class="section-title">å¤‡æ³¨</text>
      <view class="notes-content">
        <text class="notes-text">{{contactInfo.notes}}</text>
      </view>
    </view>

    <!-- æ ‡ç­¾ -->
    <view 
      class="info-section tags-section"
      wx:if="{{contactInfo.tags && contactInfo.tags.length > 0}}"
    >
      <text class="section-title">æ ‡ç­¾</text>
      <view class="tag-list">
        <view 
          wx:for="{{contactInfo.tags}}" 
          wx:key="index" 
          class="tag-wrapper"
        >
          <text class="tag-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- ä¿¡æ¯æ¥æº -->
    <view 
      class="info-section source-section"
      wx:if="{{contactInfo.source === 'wechat_message' && contactInfo.source_messages && contactInfo.source_messages.length > 0}}"
    >
      <view class="section-header" bind:tap="onToggleSourceMessages">
        <text class="section-title">ä¿¡æ¯æ¥æº</text>
        <text class="expand-icon {{showSourceMessages ? 'expanded' : ''}}">â€º</text>
      </view>
      
      <view class="source-content {{showSourceMessages ? 'expanded' : ''}}">
        <text class="source-tip">æ­¤è”ç³»äººé€šè¿‡å¾®ä¿¡æ¶ˆæ¯åˆ›å»ºï¼Œä»¥ä¸‹æ˜¯åŸå§‹ä¿¡æ¯ï¼š</text>
        <view class="source-messages">
          <view 
            wx:for="{{contactInfo.source_messages}}" 
            wx:key="id" 
            class="source-message"
          >
            <view class="message-header">
              <text class="message-time">{{formatSourceTime(item.timestamp)}}</text>
              <text class="message-type">{{formatMessageType(item.message_type)}}</text>
              <text class="message-action">{{item.action === 'created' ? 'åˆ›å»º' : 'æ›´æ–°'}}</text>
            </view>
            <view class="message-content">
              <text class="content-text" wx:if="{{item.processed_content}}">{{item.processed_content}}</text>
              <text class="content-text" wx:else>{{item.raw_content}}</text>
            </view>
            <view class="message-id" wx:if="{{item.wechat_msg_id}}">
              <text class="id-text">æ¶ˆæ¯ID: {{item.wechat_msg_id}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´ä¿¡æ¯ -->
    <view class="time-info">
      <text class="time-text">åˆ›å»ºäº {{formatDate(contactInfo.created_at)}}</text>
      <text class="time-text" wx:if="{{contactInfo.updated_at}}">æ›´æ–°äº {{formatDate(contactInfo.updated_at)}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{contactInfo && !loading && !error}}">
    <view class="bar-button" bind:tap="onEditContact">
      <text class="bar-text">ç¼–è¾‘</text>
    </view>
    <view class="bar-button delete" bind:tap="onDeleteContact">
      <text class="bar-text">åˆ é™¤</text>
    </view>
  </view>

  <!-- åˆ é™¤ç¡®è®¤ -->
  <view class="confirm-overlay {{showDeleteDialog ? 'show' : ''}}" bind:tap="onCancelDelete">
    <view class="confirm-dialog" catch:tap="onStopPropagation">
      <text class="confirm-title">ç¡®è®¤åˆ é™¤</text>
      <text class="confirm-message">åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</text>
      <view class="confirm-actions">
        <view class="confirm-button cancel" bind:tap="onCancelDelete">
          <text class="button-text">å–æ¶ˆ</text>
        </view>
        <view class="confirm-button delete" bind:tap="onConfirmDelete">
          <text class="button-text">åˆ é™¤</text>
        </view>
      </view>
    </view>
  </view>
</view>
<!--联系人详情页面-->
<view class="detail-page {{themeClass}}">
  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 错误状态 -->
  <view class="error-state" wx:if="{{error && !loading}}">
    <text class="error-message">{{error}}</text>
    <view class="error-action" bind:tap="initPageData">
      <text class="action-text">重新加载</text>
    </view>
  </view>

  <!-- 联系人详情内容 -->
  <view class="detail-content" wx:if="{{contactInfo && !loading && !error}}">
    <!-- 头部信息 -->
    <view class="header-section">
      <!-- 右上角电话按钮 -->
      <view class="header-phone-btn" wx:if="{{contactInfo.phone}}" bind:tap="onCallPhone">
        <text class="phone-icon">📞</text>
      </view>
      
      <view class="header-avatar">
        <text class="avatar-text">{{contactInfo.initial}}</text>
      </view>
      
      <view class="header-info">
        <text class="header-name">{{contactInfo.profile_name || contactInfo.name || '未知'}}</text>
        <text class="header-company" wx:if="{{contactInfo.company}}">
          {{contactInfo.company}}
        </text>
        <text class="header-position" wx:if="{{contactInfo.position}}">
          {{contactInfo.position}}
        </text>
      </view>
    </view>

    <!-- 基本信息 -->
    <view class="info-section">
      <text class="section-title">基本信息</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.phone}}">
          <text class="info-label">电话</text>
          <text class="info-value">{{contactInfo.phone}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.gender}}">
          <text class="info-label">性别</text>
          <text class="info-value">{{contactInfo.gender}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.age}}">
          <text class="info-label">年龄</text>
          <text class="info-value">{{contactInfo.age}}</text>
        </view>
      </view>
    </view>

    <!-- 工作信息 -->
    <view 
      class="info-section"
      wx:if="{{contactInfo.company || contactInfo.position}}"
    >
      <text class="section-title">工作信息</text>
      <view class="info-list">
        <view class="info-item" wx:if="{{contactInfo.company}}">
          <text class="info-label">公司</text>
          <text class="info-value">{{contactInfo.company}}</text>
        </view>
        
        <view class="info-item" wx:if="{{contactInfo.position}}">
          <text class="info-label">职务</text>
          <text class="info-value">{{contactInfo.position}}</text>
        </view>
      </view>
    </view>

    <!-- AI描述 -->
    <view 
      class="info-section ai-section"
      wx:if="{{contactInfo.ai_summary}}"
    >
      <text class="section-title">AI描述</text>
      <view class="ai-content">
        <text class="ai-text">{{contactInfo.ai_summary}}</text>
      </view>
    </view>

    <!-- 关系信息 -->
    <view class="info-section relationship-section">
      <view class="section-header" bind:tap="onViewAllRelationships">
        <text class="section-title">关系发现</text>
        <view class="section-action">
          <text class="action-text" wx:if="{{relationshipStats.total > 0}}">查看全部 ({{relationshipStats.total}})</text>
          <text class="action-text" wx:else>暂无关系</text>
          <text class="action-arrow">›</text>
        </view>
      </view>

      <!-- 关系统计 -->
      <view class="relationship-stats" wx:if="{{relationshipStats.total > 0}}">
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.confirmed}}</text>
          <text class="stat-label">已确认</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.discovered}}</text>
          <text class="stat-label">待确认</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{relationshipStats.total}}</text>
          <text class="stat-label">总关系</text>
        </view>
      </view>

      <!-- 关系预览 -->
      <view class="relationship-preview" wx:if="{{recentRelationships.length > 0}}">
        <view wx:for="{{recentRelationships}}" wx:key="id" class="relationship-preview-item" bind:tap="onViewRelationshipDetail" data-relationship-id="{{item.id}}">
          <view class="preview-avatar">
            <text class="preview-avatar-text">{{item.otherInitial}}</text>
          </view>
          <view class="preview-info">
            <text class="preview-name">{{item.otherName}}</text>
            <view class="preview-meta">
              <text class="preview-relation">{{item.relationshipLabel}}</text>
              <text class="preview-confidence" wx:if="{{item.confidenceScore > 0}}">{{item.confidenceScore}}%</text>
            </view>
          </view>
          <view class="preview-status {{item.status}}">
            <text class="status-text">{{item.statusLabel}}</text>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="relationship-empty" wx:if="{{relationshipStats.total === 0}}">
        <view class="empty-icon">
          <text class="icon-text">🔗</text>
        </view>
        <text class="empty-desc">暂未发现相关关系，系统会持续分析</text>
        <view class="empty-action" bind:tap="onAnalyzeRelationships">
          <text class="action-text">立即分析</text>
        </view>
      </view>
    </view>

    <!-- 信息来源 -->
    <view 
      class="info-section source-section" 
      wx:if="{{contactInfo.source_messages && contactInfo.source_messages.length > 0}}"
    >
      <view class="section-header" bind:tap="onToggleSourceMessages">
        <text class="section-title">原始消息记录 ({{contactInfo.source_messages.length}}条)</text>
        <view class="section-action">
          <text class="action-arrow {{showSourceMessages ? 'expanded' : ''}}">›</text>
        </view>
      </view>
      
      <view class="source-messages {{showSourceMessages ? 'expanded' : ''}}" wx:if="{{showSourceMessages}}">
        <view wx:for="{{contactInfo.source_messages}}" wx:key="id" class="message-item">
          <view class="message-header">
            <text class="message-type">{{item.message_type}}</text>
            <text class="message-time">{{formatSourceTime(item.timestamp)}}</text>
          </view>
          
          <view class="message-content" wx:if="{{item.processed_content}}">
            <text class="content-label">处理后内容：</text>
            <text class="content-text">{{item.processed_content}}</text>
          </view>
          
          <view class="message-meta" wx:if="{{item.wechat_msg_id || item.media_url}}">
            <text class="meta-label">消息详情：</text>
            <text class="meta-text" wx:if="{{item.wechat_msg_id}}">消息ID: {{item.wechat_msg_id}}</text>
            <text class="meta-text" wx:if="{{item.media_url}}">媒体URL: {{item.media_url}}</text>
          </view>
          
          <view class="message-action">
            <text class="action-label">{{item.action === 'created' ? '首次创建' : '信息更新'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 时间信息 -->
    <view class="time-info">
      <text class="time-text">创建于 {{formatDate(contactInfo.created_at)}}</text>
      <text class="time-text" wx:if="{{contactInfo.updated_at}}">更新于 {{formatDate(contactInfo.updated_at)}}</text>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar" wx:if="{{contactInfo && !loading && !error}}">
    <view class="bar-button" bind:tap="onViewAllRelationships">
      <text class="bar-text">关系</text>
      <view class="button-badge" wx:if="{{relationshipStats.discovered > 0}}">
        <text class="badge-text">{{relationshipStats.discovered}}</text>
      </view>
    </view>
    <view class="bar-button" bind:tap="onEditContact">
      <text class="bar-text">编辑</text>
    </view>
    <view class="bar-button delete" bind:tap="onDeleteContact">
      <text class="bar-text">删除</text>
    </view>
  </view>

  <!-- 删除确认 -->
  <view class="confirm-overlay {{showDeleteDialog ? 'show' : ''}}" bind:tap="onCancelDelete">
    <view class="confirm-dialog" catch:tap="onStopPropagation">
      <text class="confirm-title">确认删除</text>
      <text class="confirm-message">删除后无法恢复，确定要删除吗？</text>
      <view class="confirm-actions">
        <view class="confirm-button cancel" bind:tap="onCancelDelete">
          <text class="button-text">取消</text>
        </view>
        <view class="confirm-button delete" bind:tap="onConfirmDelete">
          <text class="button-text">删除</text>
        </view>
      </view>
    </view>
  </view>
</view>
<!--è”ç³»äººåˆ—è¡¨é¡µé¢-->
<view class="contact-list-page {{themeClass}}" bind:tap="onPageTap">
  <!-- AIæ™ºèƒ½æœç´¢æ  -->
  <view class="ai-search-header">
    <view class="search-box-container">
      <view class="search-input-wrapper">
        <!-- AIæœç´¢å›¾æ ‡ -->
        <text class="search-ai-icon">ğŸ”</text>
        
        <input 
          class="search-input ai-enhanced"
          value="{{searchQuery}}"
          placeholder="è¯•è¯•ï¼š30å²çš„ç¨‹åºå‘˜ã€åœ¨åŒ—äº¬åšé‡‘èçš„è”ç³»äºº..."
          placeholder-class="search-placeholder"
          bindinput="onSearchChange"
          bindconfirm="onSearchSubmit"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
        />
        
        <!-- æœç´¢å»ºè®®æŒ‰é’® -->
        <view class="search-suggestions-btn" wx:if="{{!searchQuery}}" bind:tap="onToggleSearchPanel">
          <text class="suggestion-icon">âœ¨</text>
        </view>
      </view>
      
      <!-- æ¸…é™¤æŒ‰é’® -->
      <view class="search-clear" wx:if="{{searchQuery}}" bind:tap="onSearchClear">
        <text class="clear-text">æ¸…é™¤</text>
      </view>
    </view>

    <!-- æœç´¢å»ºè®®é¢æ¿ -->
    <view class="search-panel {{showSearchPanel ? 'show' : ''}}">
      <!-- æœç´¢å†å² -->
      <view class="search-section" wx:if="{{searchHistory.length > 0}}">
        <view class="section-header">
          <text class="section-title">æœ€è¿‘æœç´¢</text>
          <text class="clear-history" bind:tap="onClearHistory">æ¸…é™¤</text>
        </view>
        <view class="search-tags">
          <text 
            class="search-tag history-tag" 
            wx:for="{{searchHistory}}" 
            wx:key="*this"
            bind:tap="onHistoryTap"
            data-text="{{item}}"
          >{{item}}</text>
        </view>
      </view>
      
      <!-- æ™ºèƒ½å»ºè®® -->
      <view class="search-section">
        <view class="section-title">æ™ºèƒ½å»ºè®®</view>
        <view class="search-tags">
          <text 
            class="search-tag suggestion-tag" 
            wx:for="{{searchSuggestions}}" 
            wx:key="*this"
            bind:tap="onSuggestionTap"
            data-text="{{item}}"
          >{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢åˆ†æç»“æœ -->
  <view class="ai-analysis-section" wx:if="{{searchQuery && searchAnalysis}}">
    <view class="analysis-card">
      <view class="analysis-header">
        <text class="analysis-icon">ğŸ§ </text>
        <text class="analysis-title">æ™ºèƒ½åˆ†æ</text>
      </view>
      <text class="analysis-text">{{searchAnalysis}}</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-value">{{stats.total_profiles || 0}}</text>
        <text class="stat-label">å…¨éƒ¨è”ç³»äºº</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{stats.today_profiles || 0}}</text>
        <text class="stat-label">ä»Šæ—¥æ–°å¢</text>
      </view>
    </view>
    
  </view>

  <!-- åˆ—è¡¨å†…å®¹ -->
  <view class="list-container">
    <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
    <skeleton-loader 
      wx:if="{{loading && contacts.length === 0}}"
      type="list"
      count="5"
      animation="wave"
      loading="{{true}}"
    />

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && contacts.length === 0}}">
      <text class="empty-title">{{searchQuery ? 'æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº' : 'è¿˜æ²¡æœ‰è”ç³»äºº'}}</text>
      <text class="empty-desc">{{searchQuery ? 'å°è¯•å…¶ä»–æœç´¢å…³é”®è¯' : 'ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªè”ç³»äºº'}}</text>
      <view 
        class="empty-button"
        bind:tap="onAddContact"
        wx:if="{{!searchQuery}}"
      >
        <text class="button-text">æ·»åŠ è”ç³»äºº</text>
      </view>
    </view>

    <!-- è”ç³»äººåˆ—è¡¨ -->
    <view class="contact-list" wx:if="{{contacts.length > 0}}">
      <view class="contact-group">
        <view 
          wx:for="{{contacts}}"
          wx:key="id"
          class="swipe-container {{item.isHighMatch ? 'high-match' : ''}}" 
          data-index="{{index}}"
        >
          <!-- è”ç³»äººä¸»ä½“å†…å®¹ -->
          <view 
            class="contact-item {{swipeStates[index] ? 'swiped' : ''}}"
            bind:tap="onContactTap"
            bind:longpress="onContactLongPress"
            bind:touchstart="onTouchStart"
            bind:touchmove="onTouchMove"
            bind:touchend="onTouchEnd"
            data-contact="{{item}}"
            data-index="{{index}}"
          >
          <!-- åŒ¹é…åº¦æ ‡è¯† -->
          <view class="match-indicator" wx:if="{{searchQuery && item.matchScore}}">
            <view class="match-badge {{item.isHighMatch ? 'high' : 'normal'}}">
              <text class="match-text">{{item.matchPercentage}}%</text>
            </view>
          </view>
          
          <view class="item-avatar" style="background-color: {{item.avatarColor}}">
            <text class="avatar-text">{{item.initial}}</text>
          </view>
          
          <view class="item-content">
            <view class="item-header">
              <text class="item-name">{{item.profile_name || item.name || 'æœªçŸ¥'}}</text>
              <view class="match-star" wx:if="{{searchQuery && item.isHighMatch}}">â­</view>
            </view>
            <text class="item-detail" wx:if="{{item.company || item.position}}">
              {{item.company}}{{item.company && item.position ? ' Â· ' : ''}}{{item.position}}
            </text>
            
            <!-- æ ‡ç­¾å±•ç¤º -->
            <view class="item-tags" wx:if="{{item.formattedTags && item.formattedTags.length > 0}}">
              <view 
                wx:for="{{item.formattedTags}}" 
                wx:key="*this"
                wx:for-item="tag"
                class="tag-wrapper"
              >
                <text class="tag-text">{{tag}}</text>
              </view>
            </view>
          </view>
          
          <text class="item-arrow">â€º</text>
          </view>
          
          <!-- æ»‘åŠ¨æ“ä½œåŒºåŸŸ -->
          <view class="swipe-actions" data-contact-id="{{item.id}}" data-index="{{index}}">
            <view class="action-btn action-edit" bind:tap="onEditContact">
              <text class="action-icon">âœï¸</text>
              <text class="action-text">ç¼–è¾‘</text>
            </view>
            <view class="action-btn action-delete" bind:tap="onDeleteContact">
              <text class="action-icon">ğŸ—‘ï¸</text>
              <text class="action-text">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && contacts.length > 0}}">
      <view 
        class="load-more-button {{loadingMore ? 'disabled' : ''}}"
        bind:tap="onLoadMore"
      >
        <text class="button-text">{{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
        <view class="loading-spinner" wx:if="{{loadingMore}}"></view>
      </view>
    </view>

    <!-- åˆ—è¡¨æœ«å°¾ -->
    <view class="list-end" wx:if="{{contacts.length > 0 && !hasMore && !loading}}">
      <text class="end-text">å·²æ˜¾ç¤ºå…¨éƒ¨è”ç³»äºº</text>
    </view>
  </view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="add-button" catch:tap="onToggleAddMenu">
    <text class="add-text {{showAddMenu ? 'rotated' : ''}}">+</text>
  </view>

  <!-- æ·»åŠ èœå• -->
  <view class="add-menu {{showAddMenu ? 'show' : ''}}" catch:tap="onStopPropagation">
    <view class="add-menu-item" bind:tap="onAddContact">
      <text class="menu-icon">âœï¸</text>
      <text class="menu-text">æ–°å»ºè”ç³»äºº</text>
    </view>
    <view class="add-menu-item" bind:tap="onImportFromPhoneBook">
      <text class="menu-icon">ğŸ“±</text>
      <text class="menu-text">ä»é€šè®¯å½•å¯¼å…¥</text>
    </view>
    <view class="add-menu-item" bind:tap="onBatchImport">
      <text class="menu-icon">ğŸ“„</text>
      <text class="menu-text">æ–‡æœ¬å¯¼å…¥</text>
    </view>
  </view>

  <!-- æ·»åŠ èœå•é®ç½© -->
  <view class="add-menu-mask {{showAddMenu ? 'show' : ''}}" bind:tap="onCloseAddMenu"></view>

  <!-- æ“ä½œèœå• -->
  <view class="action-overlay {{showActionMenu ? 'show' : ''}}" bind:tap="onCloseActionMenu">
    <view class="action-sheet" catch:tap="onStopPropagation">
      <view class="sheet-header">
        <view class="sheet-avatar">
          <text class="avatar-text">{{selectedContact.initial}}</text>
        </view>
        <view class="sheet-info">
          <text class="sheet-name">{{selectedContact.profile_name || selectedContact.name}}</text>
          <text class="sheet-company" wx:if="{{selectedContact.company}}">{{selectedContact.company}}</text>
        </view>
      </view>
      <view class="sheet-actions">
        <view class="sheet-button" bind:tap="onViewDetail">
          <text class="button-text">æŸ¥çœ‹è¯¦æƒ…</text>
        </view>
        <view class="sheet-button" bind:tap="onEditContact">
          <text class="button-text">ç¼–è¾‘</text>
        </view>
        <view class="sheet-button delete" bind:tap="onDeleteContact">
          <text class="button-text">åˆ é™¤</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è‡ªå®šä¹‰TabBar -->
  <custom-tabbar current="contact-list" />
  
  <!-- å¯¼å…¥è¿›åº¦æ˜¾ç¤º -->
  <import-progress 
    visible="{{showImportProgress}}"
    progress="{{importProgress}}"
    bind:close="onCloseImportProgress"
  />
  
  
  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <custom-modal
    visible="{{showDeleteModal}}"
    title="åˆ é™¤è”ç³»äºº"
    content="ç¡®å®šè¦åˆ é™¤ã€Œ{{deleteContactName}}ã€å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚"
    confirmText="åˆ é™¤"
    cancelText="å–æ¶ˆ"
    confirmType="danger"
    bind:confirm="onConfirmDelete"
    bind:cancel="onCancelDelete"
    bind:close="onCloseDeleteModal"
  />
  
</view>
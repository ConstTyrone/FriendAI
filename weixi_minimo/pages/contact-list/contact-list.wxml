<!--联系人列表页面-->
<view class="contact-list-page {{themeClass}}" bind:tap="onPageTap">
  <!-- 增强搜索栏 -->
  <view class="enhanced-search-header">
    <view class="search-box-container">
      <view class="search-input-wrapper">
        <input 
          class="search-input intelligent-mode"
          value="{{searchQuery}}"
          placeholder="智能搜索：30岁的程序员、在北京做金融的..."
          placeholder-class="search-placeholder"
          bindinput="onSearchChange"
          bindconfirm="onSearchSubmit"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
        />
        
        <!-- 搜索建议按钮 -->
        <view class="search-suggestions-btn" wx:if="{{!searchQuery}}" bind:tap="onToggleSearchPanel">
          <text class="suggestion-icon">▼</text>
        </view>
      </view>
      
      <!-- 清除按钮 -->
      <view class="search-clear" wx:if="{{searchQuery}}" bind:tap="onSearchClear">
        <text class="clear-text">清除</text>
      </view>
    </view>

    <!-- 搜索建议面板 -->
    <view class="search-panel {{showSearchPanel ? 'show' : ''}}">
      <!-- 搜索历史 -->
      <view class="search-section" wx:if="{{searchHistory.length > 0}}">
        <view class="section-header">
          <text class="section-title">最近搜索</text>
          <text class="clear-history" bind:tap="onClearHistory">清除</text>
        </view>
        <view class="search-tags">
          <text 
            class="search-tag history-tag" 
            wx:for="{{searchHistory}}" 
            wx:key="*this"
            bind:tap="onHistoryTap"
            data-text="{{item}}"
          >{{item}}</text>
        </view>
      </view>
      
      <!-- 智能建议 -->
      <view class="search-section">
        <view class="section-title">智能建议</view>
        <view class="search-tags">
          <text 
            class="search-tag suggestion-tag" 
            wx:for="{{searchSuggestions}}" 
            wx:key="*this"
            bind:tap="onSuggestionTap"
            data-text="{{item}}"
          >{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索分析结果 -->
  <view class="ai-analysis-section" wx:if="{{searchQuery && searchAnalysis}}">
    <view class="analysis-card">
      <view class="analysis-header">
        <text class="analysis-icon">🧠</text>
        <text class="analysis-title">智能分析</text>
      </view>
      <text class="analysis-text">{{searchAnalysis}}</text>
    </view>
  </view>

  <!-- 统计信息 -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-value">{{stats.total_profiles || 0}}</text>
        <text class="stat-label">全部联系人</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{stats.today_profiles || 0}}</text>
        <text class="stat-label">今日新增</text>
      </view>
    </view>
  </view>

  <!-- 列表内容 -->
  <view class="list-container">
    <!-- 骨架屏加载状态 -->
    <skeleton-loader 
      wx:if="{{loading && contacts.length === 0}}"
      type="list"
      count="5"
      animation="wave"
      loading="{{true}}"
    />

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && contacts.length === 0}}">
      <text class="empty-title">{{searchQuery ? '没有找到联系人' : '还没有联系人'}}</text>
      <text class="empty-desc">{{searchQuery ? '尝试其他搜索关键词' : '点击右下角按钮添加第一个联系人'}}</text>
      <view 
        class="empty-button"
        bind:tap="onAddContact"
        wx:if="{{!searchQuery}}"
      >
        <text class="button-text">添加联系人</text>
      </view>
    </view>

    <!-- 联系人列表 -->
    <view class="contact-list" wx:if="{{contacts.length > 0}}">
      <view class="contact-group">
        <view 
          wx:for="{{contacts}}"
          wx:key="id"
          class="contact-item-wrapper {{item.isHighMatch ? 'high-match' : ''}}"
          data-contact="{{item}}"
          data-index="{{index}}"
        >
          <!-- 联系人主体内容 -->
          <view 
            class="contact-item {{swipeStates[index] ? 'swiped' : ''}}"
            bind:tap="onContactTap"
            bind:longpress="onContactLongPress"
            bind:touchstart="onTouchStart"
            bind:touchmove="onTouchMove"
            bind:touchend="onTouchEnd"
            data-contact="{{item}}"
            data-index="{{index}}"
          >
          <!-- 匹配度标识 -->
          <view class="match-indicator" wx:if="{{searchQuery && item.matchScore}}">
            <view class="match-badge {{item.isHighMatch ? 'high' : 'normal'}}">
              <text class="match-text">{{item.matchPercentage}}%</text>
            </view>
          </view>
          
          <view class="item-avatar" style="background-color: {{item.avatarColor}}">
            <text class="avatar-text">{{item.initial}}</text>
          </view>
          
          <view class="item-content">
            <view class="item-header">
              <text class="item-name">{{item.profile_name || item.name || '未知'}}</text>
              <view class="match-star" wx:if="{{searchQuery && item.isHighMatch}}">⭐</view>
            </view>
            <text class="item-detail" wx:if="{{item.company || item.position}}">
              {{item.company}}{{item.company && item.position ? ' · ' : ''}}{{item.position}}
            </text>
            
            <!-- 标签展示 -->
            <view class="item-tags" wx:if="{{item.formattedTags && item.formattedTags.length > 0}}">
              <view 
                wx:for="{{item.formattedTags}}" 
                wx:key="*this"
                wx:for-item="tag"
                class="tag-wrapper"
              >
                <text class="tag-text">{{tag}}</text>
              </view>
            </view>
          </view>
          
          <text class="item-arrow">›</text>
          </view>
          
          <!-- 滑动操作区域 -->
          <view class="swipe-actions">
            <view class="action-btn action-edit" bind:tap="onEditContact" data-contact="{{item}}" data-index="{{index}}">
              <text class="action-icon">✏️</text>
              <text class="action-text">编辑</text>
            </view>
            <view class="action-btn action-delete" bind:tap="onDeleteContact" data-contact="{{item}}" data-index="{{index}}">
              <text class="action-icon">🗑️</text>
              <text class="action-text">删除</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore && contacts.length > 0}}">
      <view 
        class="load-more-button {{loadingMore ? 'disabled' : ''}}"
        bind:tap="onLoadMore"
      >
        <text class="button-text">{{loadingMore ? '加载中...' : '加载更多'}}</text>
        <view class="loading-spinner" wx:if="{{loadingMore}}"></view>
      </view>
    </view>

    <!-- 列表末尾 -->
    <view class="list-end" wx:if="{{contacts.length > 0 && !hasMore && !loading}}">
      <text class="end-text">已显示全部联系人</text>
    </view>
  </view>

  <!-- 添加按钮 -->
  <view class="add-button" bind:tap="onAddContact">
    <text class="add-text">+</text>
  </view>

  <!-- 操作菜单 -->
  <view class="action-overlay {{showActionMenu ? 'show' : ''}}" bind:tap="onCloseActionMenu">
    <view class="action-sheet" catch:tap="onStopPropagation">
      <view class="sheet-header">
        <view class="sheet-avatar">
          <text class="avatar-text">{{selectedContact.initial}}</text>
        </view>
        <view class="sheet-info">
          <text class="sheet-name">{{selectedContact.profile_name || selectedContact.name}}</text>
          <text class="sheet-company" wx:if="{{selectedContact.company}}">{{selectedContact.company}}</text>
        </view>
      </view>
      <view class="sheet-actions">
        <view class="sheet-button" bind:tap="onViewDetail">
          <text class="button-text">查看详情</text>
        </view>
        <view class="sheet-button" bind:tap="onEditContact">
          <text class="button-text">编辑</text>
        </view>
        <view class="sheet-button delete" bind:tap="onDeleteContact">
          <text class="button-text">删除</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 自定义TabBar -->
  <custom-tabbar current="contact-list" />
</view>
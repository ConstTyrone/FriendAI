<!--设置页面-->
<view class="settings-page {{themeClass}}">
  <!-- 用户信息区域 -->
  <view class="user-section" wx:if="{{isLoggedIn}}">
    <view class="user-card">
      <view class="user-avatar" style="background-color: {{userProfile.avatarColor}}" bind:tap="onEditProfile">
        <text class="avatar-text">{{userProfile.avatarText || 'U'}}</text>
      </view>
      
      <view class="user-info">
        <view class="user-name-row">
          <text class="user-name">{{userProfile.displayName || '未设置姓名'}}</text>
          <view class="edit-button" bind:tap="onEditProfile">
            <t-icon name="edit" size="20rpx" color="#999999" />
          </view>
        </view>
        
        <view class="user-details">
          <text class="user-nickname" wx:if="{{userProfile.nickname}}">{{userProfile.nickname}}</text>
          <text class="user-bio" wx:if="{{userProfile.bio}}">{{userProfile.bio}}</text>
          <view class="user-bind-status">
            <view class="bind-status {{userInfo.isBound ? 'bound' : 'unbound'}}">
              <text class="bind-status-text">{{userInfo.isBound ? '已绑定微信客服' : '小程序独立模式'}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="user-stats">
        <view class="stat-item">
          <text class="stat-number">{{stats.total_profiles || 0}}</text>
          <text class="stat-label">联系人</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{stats.today_profiles || 0}}</text>
          <text class="stat-label">今日新增</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 登录区域 -->
  <view class="login-section" wx:if="{{!isLoggedIn}}">
    <view class="login-card">
      <view class="login-header">
        <text class="login-title">登录账户</text>
        <text class="login-subtitle">使用微信账户一键登录</text>
      </view>
      
      <view class="login-form">
        <!-- 微信一键登录按钮 -->
        <view 
          class="login-button primary {{loginLoading ? 'disabled' : ''}}"
          bind:tap="onRealWechatLogin"
        >
          <text class="button-text">{{loginLoading ? '登录中...' : '微信一键登录'}}</text>
          <view class="loading-spinner" wx:if="{{loginLoading}}"></view>
        </view>
        
        <view class="login-tips">
          <text class="tips-text">安全便捷，一键即可开始使用</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 设置选项 -->
  <view class="settings-options">
    <!-- 账户管理 -->
    <view class="option-group" wx:if="{{isLoggedIn}}">
      <text class="group-title">账户管理</text>
      <view class="option-list">
        <view class="option-item" bind:tap="onBindWechatService" wx:if="{{!userInfo.isBound}}">
          <view class="option-content">
            <text class="option-title">绑定微信客服</text>
            <text class="option-note">获得消息自动分析功能（可选）</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onManageWechatBinding" wx:if="{{userInfo.isBound}}">
          <view class="option-content">
            <text class="option-title">解除微信客服绑定</text>
            <text class="option-note">解除绑定后可重新绑定新客服</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onRefreshUserInfo">
          <view class="option-content">
            <text class="option-title">刷新用户信息</text>
            <text class="option-note">重新获取用户统计数据</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onClearCache">
          <view class="option-content">
            <text class="option-title">清除缓存</text>
            <text class="option-note">清除本地缓存的联系人数据</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onLogout">
          <view class="option-content">
            <text class="option-title danger">退出登录</text>
            <text class="option-note">清除登录信息并退出</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
      </view>
    </view>

    <!-- 应用设置 -->
    <view class="option-group">
      <text class="group-title">应用设置</text>
      <view class="option-list">
        <view class="option-item">
          <view class="option-content">
            <text class="option-title">自动同步</text>
            <text class="option-note">定期同步最新数据</text>
          </view>
          <switch 
            class="option-switch"
            checked="{{settings.autoSync}}" 
            bindchange="onAutoSyncChange"
          />
        </view>
        
        <view class="option-item">
          <view class="option-content">
            <text class="option-title">消息通知</text>
            <text class="option-note">接收重要更新通知</text>
          </view>
          <switch 
            class="option-switch"
            checked="{{settings.notifications}}" 
            bindchange="onNotificationsChange"
          />
        </view>
        
        <view class="option-item">
          <view class="option-content">
            <text class="option-title">深色模式</text>
            <text class="option-note">跟随系统或手动设置</text>
          </view>
          <switch 
            class="option-switch"
            checked="{{settings.darkMode}}" 
            bindchange="onDarkModeChange"
          />
        </view>
        
      </view>
    </view>

    <!-- 数据统计 -->
    <view class="option-group" wx:if="{{isLoggedIn}}">
      <text class="group-title">数据统计</text>
      <view class="option-list">
        <view class="option-item" bind:tap="onViewStorageInfo">
          <view class="option-content">
            <text class="option-title">存储使用情况</text>
            <text class="option-note">查看本地数据使用情况</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onViewAPIStats">
          <view class="option-content">
            <text class="option-title">API调用统计</text>
            <text class="option-note">查看接口调用情况</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
      </view>
    </view>

    <!-- 关于应用 -->
    <view class="option-group">
      <text class="group-title">关于应用</text>
      <view class="option-list">
        <view class="option-item" bind:tap="onViewVersion">
          <view class="option-content">
            <text class="option-title">版本信息</text>
            <text class="option-note">v{{appVersion}}</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onViewHelp">
          <view class="option-content">
            <text class="option-title">帮助支持</text>
            <text class="option-note">使用指南和常见问题</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
        
        <view class="option-item" bind:tap="onViewFeedback">
          <view class="option-content">
            <text class="option-title">反馈建议</text>
            <text class="option-note">向我们反馈问题或建议</text>
          </view>
          <text class="option-arrow">›</text>
        </view>
      </view>
    </view>

    <!-- 开发者选项 (仅开发环境显示) -->
    <view class="option-group" wx:if="{{isLoggedIn}}">
      <text class="group-title">🧪 开发者选项</text>
      <view class="option-list">
        <view class="option-item" bind:tap="onSystemDiagnosis">
          <view class="option-content">
            <text class="option-title">系统诊断</text>
            <text class="option-note">全面检查系统状态和功能</text>
          </view>
          <text class="option-arrow">🏥</text>
        </view>
        
        <view class="option-item" bind:tap="onPermissionManager">
          <view class="option-content">
            <text class="option-title">权限管理</text>
            <text class="option-note">检查和管理通讯录权限</text>
          </view>
          <text class="option-arrow">🔐</text>
        </view>
        
        <view class="option-item" bind:tap="onTestBatchImport">
          <view class="option-content">
            <text class="option-title">测试批量导入</text>
            <text class="option-note">运行批量导入功能测试套件</text>
          </view>
          <text class="option-arrow">🧪</text>
        </view>
        
        <view class="option-item" bind:tap="onResetBatchImportConfig">
          <view class="option-content">
            <text class="option-title">重置导入配置</text>
            <text class="option-note">重置批量导入配置到默认值</text>
          </view>
          <text class="option-arrow">🔧</text>
        </view>
        
        <view class="option-item" bind:tap="onShowSplashScreen">
          <view class="option-content">
            <text class="option-title">启动动画演示</text>
            <text class="option-note">查看应用启动动画效果</text>
          </view>
          <text class="option-arrow">✨</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 登出确认对话框 -->
  <t-dialog
    visible="{{showLogoutDialog}}"
    title="确认退出"
    content="退出登录后，本地缓存的数据将被清除。确定要退出吗？"
    confirm-btn="退出"
    cancel-btn="取消"
    bind:confirm="onConfirmLogout"
    bind:cancel="onCancelLogout"
  />

  <!-- 个人资料编辑器 -->
  <profile-editor
    visible="{{showProfileEditor}}"
    initial-data="{{userProfile}}"
    bind:save="onProfileSave"
    bind:cancel="onProfileCancel"
  />

  <!-- 自定义TabBar -->

  <custom-tabbar current="settings" />
</view>
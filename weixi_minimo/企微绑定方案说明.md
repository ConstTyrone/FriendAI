# 企微客服绑定方案说明

## 当前问题

1. **企微客服URL限制**：
   - 企微客服URL格式固定：`https://work.weixin.qq.com/kfid/kfc6fac668195f8389e`
   - 无法通过URL参数传递自定义的state（bindToken）

2. **Web-view限制**：
   - 小程序web-view需要配置业务域名
   - 企微域名可能无法配置为业务域名

## 解决方案

### 方案一：通过用户消息传递Token（推荐）

**流程**：
1. 生成绑定Token后，显示给用户
2. 用户复制Token
3. 用户打开企微客服链接
4. 在客服对话中发送Token
5. 后端通过企微接收消息，获取Token和external_userid
6. 完成绑定

**前端实现**：
```javascript
// 生成Token后显示
wx.showModal({
  title: '绑定步骤',
  content: `1. 复制验证码：${bindToken}\n2. 打开企微客服\n3. 发送验证码完成绑定`,
  confirmText: '复制验证码',
  success: (res) => {
    if (res.confirm) {
      wx.setClipboardData({
        data: bindToken,
        success: () => {
          // 打开企微客服
          wx.setClipboardData({
            data: 'https://work.weixin.qq.com/kfid/kfc6fac668195f8389e',
            success: () => {
              wx.showToast({
                title: '请在浏览器打开链接并发送验证码',
                icon: 'none',
                duration: 3000
              });
            }
          });
        }
      });
    }
  }
});
```

### 方案二：基于OpenID直接绑定

**流程**：
1. 用户登录小程序，后端记录OpenID
2. 用户访问企微客服
3. 后端通过企微API获取客服会话信息
4. 通过时间窗口匹配（如5分钟内）完成绑定

**优点**：
- 用户操作简单
- 不需要传递Token

**缺点**：
- 可能存在误绑定风险
- 需要企微API权限

### 方案三：使用企业微信小程序

如果你们有企业微信，可以考虑：
1. 开发企业微信小程序
2. 在企微小程序中获取external_userid
3. 与微信小程序共享数据

## 后端接口调整

### 1. 修改绑定回调接口

**原接口**：
```python
@app.post("/api/binding/callback")
async def binding_callback(state: str, external_userid: str):
    # 通过state获取openid
```

**新接口**：
```python
@app.post("/api/wechat-work/message")
async def handle_customer_message(request: Request):
    """
    处理企微客服消息
    当用户发送消息时，提取Token和external_userid
    """
    # 解析消息内容
    message = parse_message(request)
    
    # 如果消息是Token格式（如6位数字）
    if is_valid_token(message.content):
        token = message.content
        external_userid = message.external_userid
        
        # 完成绑定
        complete_binding(token, external_userid)
```

### 2. Token生成策略

为了方便用户输入，Token可以设计为：
- 6位数字：`123456`
- 4位字母数字：`A1B2`
- 易读单词组合：`apple-blue-cat`

## 实施建议

1. **先使用方案一**（通过消息传递Token）：
   - 实现简单
   - 用户体验可接受
   - 安全性好

2. **优化用户体验**：
   - 生成简短易输入的Token
   - 提供清晰的操作指引
   - 自动复制Token到剪贴板

3. **后续优化**：
   - 探索企微API自动化绑定
   - 考虑开发企业微信小程序

## 前端代码调整

需要修改 `bind-account.js`：
- 生成简短Token（如6位数字）
- 显示Token给用户
- 提供复制功能
- 清晰的操作指引

## 后端代码调整

需要实现：
- 企微消息接收接口
- Token验证逻辑
- 绑定完成通知
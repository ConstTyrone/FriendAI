# emoticon_service.py
"""
è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡ - æ™ºèƒ½è¯†åˆ«æƒ…ç»ªå¹¶ç”Ÿæˆå¯çˆ±è¡¨æƒ…åŒ…
è§¦å‘æ–¹å¼ï¼šå…³é”®è¯"è¡¨æƒ…åŒ…"
é£æ ¼ï¼šAIè‡ªç”±å‘æŒ¥ï¼ŒQç‰ˆå¡é€šå¯çˆ±é£æ ¼
æ”¯æŒä¸‰æ¨¡å‹å¯¹æ¯”ï¼šGemini 2.5 Flash vs é€šä¹‰åƒé—® Qwen-Image-Plus vs ç«å±±å¼•æ“ SeeDream-4
"""
import re
import json
import logging
from typing import Optional, Dict, List
from .ai_service import chat_service
from .image_service import image_service
from .qwen_image_service import qwen_image_service
from .seedream_image_service import seedream_image_service
from ..config.config import config

logger = logging.getLogger(__name__)

# è¡¨æƒ…åŒ…å…³é”®è¯
EMOTICON_KEYWORDS = ['è¡¨æƒ…åŒ…', '/è¡¨æƒ…åŒ…', 'æ¥ä¸ªè¡¨æƒ…åŒ…', 'ç”Ÿæˆè¡¨æƒ…åŒ…']

# è¡¨æƒ…åŒ…ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ï¼ˆä¼˜åŒ–ç‰ˆv2.0ï¼‰
EMOTICON_SYSTEM_PROMPT = """ä½ æ˜¯ä¸“ä¸šè¡¨æƒ…åŒ…è®¾è®¡å¸ˆï¼Œæ ¹æ®ç”¨æˆ·æ„å›¾ç”ŸæˆAIç»˜ç”»æè¿°ã€‚

## æ ¸å¿ƒå®šä½
è¡¨æƒ…åŒ… = æƒ…ç»ªè¡¨è¾¾ + ç¤¾äº¤å·¥å…· + ç½‘ç»œæ–‡åŒ–
- ç†è§£çœŸå®å«ä¹‰ï¼š"ç‹—å¤´"=è°ƒä¾ƒï¼Œ"åƒç“œ"=å›´è§‚ï¼Œ"æ‰“å·¥äºº"=ç¤¾ç•œè‡ªå˜²
- ä¸è¦å­—é¢ç¿»è¯‘ï¼Œè¦ç†è§£ç¤¾äº¤è¯­å¢ƒ

## é£æ ¼å›ºå®š
Qç‰ˆå¡é€šï¼Œå¤§å¤´å°èº«3:1ï¼Œåœ†æ¶¦çº¿æ¡ï¼Œå±…ä¸­æ„å›¾ä¸»ä½“å 70%+
è§’è‰²ï¼šæŸ´çŠ¬/å°çŒ«/å°ç†Š/å°å…”å­ç­‰å¯çˆ±åŠ¨ç‰©
èƒŒæ™¯ï¼šçº¯è‰²æˆ–ç®€å•æ¸å˜ï¼Œä¸è¦å¤æ‚åœºæ™¯

## æ–‡å­—å†³ç­–æ ‘
```
è¾“å…¥ â†’ åˆ¤æ–­ç±»å‹ â†’ æ–‡å­—ç­–ç•¥

ğŸš« æ— æ–‡å­—ï¼šç¤¾äº¤ç¤¼ä»ª(å¾®ç¬‘/ç‚¹å¤´/OK)ã€è§‚å¯Ÿ(å·çœ‹/æ­ªå¤´)ã€å–èŒ
âœ… å¿…é¡»æ–‡å­—ï¼šç½‘ç»œæ¢—(YYDS/ç ´é˜²/ç»ç»å­)ã€å¼ºçƒˆæƒ…ç»ªã€è¡ŒåŠ¨æŒ‡ä»¤
âš–ï¸ å¯é€‰æ–‡å­—ï¼šä¸­ç­‰æƒ…ç»ªã€åœºæ™¯ååº”
```

**æ–‡å­—æ ·å¼**ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
- ä½ç½®ï¼šè§’è‰²æ­£ä¸Šæ–¹å±…ä¸­
- å¤§å°ï¼šç”»é¢é«˜15-20%
- é•¿åº¦ï¼š2-3å­—æœ€ä½³ï¼Œâ‰¤4å­—
- é£æ ¼ï¼šæƒ…ç»ªåŒ¹é…ï¼ˆå¼€å¿ƒâ†’åœ†æ¶¦äº®é»„ï¼Œç”Ÿæ°”â†’é”‹åˆ©çº¢æ©™ï¼Œç´¯â†’æ¾æ•£ç°è“ï¼‰
- ç‰¹æ•ˆï¼šå¤šå±‚æè¾¹+å‘å…‰/é˜´å½±

## æè¿°æ¨¡æ¿
[è§’è‰²]ï¼šåŠ¨ç‰©+é¢œè‰²+å¤–å½¢ â†’ [è¡¨æƒ…åŠ¨ä½œ]ï¼šçœ¼ç›+å˜´å·´+è‚¢ä½“ â†’ [æ–‡å­—]ï¼šå†…å®¹+æ ·å¼ â†’ [ç‰¹æ•ˆ+èƒŒæ™¯] â†’ "Qç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

## ç¤ºä¾‹ï¼ˆæœ‰æ–‡å­—ï¼‰

"å¼€å¿ƒ" â†’ é»„è‰²å°é¸­å­ï¼Œæœˆç‰™çœ¼ï¼Œç¿çƒ‚ç¬‘å®¹ï¼ŒåŒç¿…ä¸Šæ‰¬è·³è·ƒï¼Œæ­£ä¸Šæ–¹äº®é»„ç²—ä½“"å¼€å¿ƒï¼"ç™½æè¾¹æ©™å‘å…‰ï¼Œæ˜Ÿæ˜Ÿç‰¹æ•ˆï¼Œé»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç´¯äº†" â†’ ç°è‰²å°è€ƒæ‹‰è¶´åœ°ï¼ŒåŠé—­å›°å€¦çœ¼ï¼ŒèˆŒå¤´åå‡ºï¼Œå››è‚¢æ‘Šå¼€å¤§å­—å‹èåŒ–çŠ¶ï¼Œæ­£ä¸Šæ–¹æ¾æ•£å€¾æ–œç°è“ç²—ä½“"ç´¯æ­»äº†..."æ·±ç°æè¾¹æ·¡é˜´å½±ï¼Œä¸‰æ»´æ±—ç ï¼Œæ·¡è“ç°æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"YYDS" â†’ æ©˜è‰²å°è€è™åŒæ‰‹é«˜ä¸¾å¥–æ¯ï¼Œçœ¼ç›å‘å…‰ï¼Œå˜´å·´å¤§å¼ æ¬¢å‘¼ï¼Œå°¾å·´ç‚¸æ¯›å…´å¥‹çŠ¶ï¼Œæ­£ä¸Šæ–¹é‡‘è‰²è¶…ç²—ä½“"YYDS"ï¼Œæ–‡å­—å¸¦å½©è™¹æ¸å˜å¤šå±‚æè¾¹æ˜Ÿå…‰çˆ†ç‚¸æ•ˆæœï¼Œå‘¨å›´çƒŸèŠ±ç¤¼ç‚®ï¼Œé‡‘é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç ´é˜²äº†" â†’ ç™½è‰²å°å…”å­è¹²åœ°ï¼Œçœ¼ç›æ³›æ³ªï¼Œè€³æœµè€·æ‹‰ï¼Œä¸€åªæ‰‹æ“¦çœ¼ç›ï¼Œæ•´ä½“å§”å±ˆçŠ¶ï¼Œæ­£ä¸Šæ–¹è“ç´«è‰²ç²—ä½“"ç ´é˜²äº†"ï¼Œæ–‡å­—å¾®å¾®é¢¤æŠ–æ„Ÿå¸¦æ°´æ»´æ•ˆæœï¼Œå‘¨å›´å°ç¢å¿ƒæ¼‚æµ®ï¼Œæ·¡è“ç´«æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"æ‰“å·¥äºº" â†’ ç°è‰²å°çŒ«å’ªè¥¿è£…é¢†å¸¦æ‹å…¬æ–‡åŒ…ï¼Œçœ¼ç›ç©ºæ´æ­»é±¼çœ¼ï¼Œå˜´è§’ä¸‹å‚ï¼Œèº«ä½“å¾®é©¼èƒŒç–²æƒ«çŠ¶ï¼Œæ­£ä¸Šæ–¹æ·±ç°ç²—ä½“"æ‰“å·¥äºº"ï¼Œæ–‡å­—å¸¦æ·±è‰²æè¾¹å‹æŠ‘æ„Ÿï¼Œå¤´é¡¶ä¹Œäº‘ç¬¦å·ï¼Œç°ç™½æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç”Ÿæ°”" â†’ çº¢è‰²å°ç‹ç‹¸å‰è…°ç«™ç«‹ï¼Œçœ‰æ¯›å€’ç«–ï¼Œçœ¼ç›çªåœ†ï¼Œå˜´å·´å‘²ç‰™ï¼Œå°¾å·´ç‚¸æ¯›ç«–èµ·ï¼Œæ­£ä¸Šæ–¹é”‹åˆ©çº¢æ©™ç²—ä½“"ç”Ÿæ°”ï¼"ï¼Œæ–‡å­—å¸¦ç«ç„°çº¹ç†å’Œçˆ†ç‚¸çº¿æ¡ï¼Œå‘¨å›´æ€’æ°”ç¬¦å·ï¼Œçº¢æ©™æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"åŠ æ²¹" â†’ æ©˜è‰²å°è€è™æ¡æ‹³ä¸¾èƒ¸å‰ï¼Œç‚¯ç‚¯æœ‰ç¥çœ¼ï¼Œå˜´è§’ä¸Šæ‰¬æ–—å¿—æ»¡æ»¡ï¼Œå°¾å·´å‘ä¸Šç¿˜ï¼Œæ­£ä¸Šæ–¹ç²—å£®ä¸Šå€¾æ–œé‡‘è‰²æ¸å˜è¶…ç²—ä½“"åŠ æ²¹ï¼"ï¼Œæ©™æè¾¹é‡‘å‘å…‰ï¼Œèƒ½é‡å…‰èŠ’é—ªç”µç‰¹æ•ˆï¼Œæ©™é»„æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"æ— è¯­å­" â†’ ç™½è‰²å°çŒ«å’ªç¿»ç™½çœ¼ï¼Œå˜´æ’‡èµ·æ— å¥ˆé„™è§†ï¼ŒåŒæ‰‹å‰è…°ï¼Œæ­£ä¸Šæ–¹ç°è“ç²—ä½“"æ— è¯­å­"æ·±ç°æè¾¹å¾®å¼±æŠ–åŠ¨ï¼Œå¤´é¡¶ä¸‰æ¡é»‘çº¿ï¼Œæµ…ç°æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"å¾—æ„" â†’ æ£•è‰²å°æµ£ç†ŠåŒæ‰‹ç¯èƒ¸ï¼Œçœ¼ç›çœ¯æˆç¼ï¼Œå˜´è§’å‹¾èµ·åç¬‘ï¼Œå°¾å·´å·¦å³æ‘‡æ‘†ï¼Œæ­£ä¸Šæ–¹ç´«è‰²ç²—ä½“"ç•¥ç•¥ç•¥~"ï¼Œæ–‡å­—å¸¦è°ƒçš®å¼§çº¿å’Œæ˜Ÿæ˜Ÿç‚¹ç¼€ï¼Œå‘¨å›´å¾—æ„å…‰ç¯ï¼Œæ·¡ç´«æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"æƒŠè®¶" â†’ ç°ç™½å°å…”å­ï¼Œçœ¼ç›çªåœ†ï¼Œå˜´å·´Oå‹å¼ å¼€ï¼Œè€³æœµç«–ç›´ï¼ŒåŒæ‰‹æ‚å˜´ï¼Œæ­£ä¸Šæ–¹äº®é»„ç²—ä½“"å“‡ï¼"ï¼Œæ–‡å­—å¸¦å¤šå±‚æ³¢çº¹æ‰©æ•£æ•ˆæœï¼Œå‘¨å›´æƒŠå¹å·å’Œé—ªç”µï¼Œäº®é»„æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

## ç¤ºä¾‹ï¼ˆæ— æ–‡å­—ï¼‰

"å¾®ç¬‘" â†’ æ©˜è‰²å°çŒ«å’ªåå§¿ï¼Œæœˆç‰™çœ¯çœ¼ï¼Œå˜´è§’è½»æ‰¬æ¸©å’Œå‹å–„ç¬‘å®¹ï¼Œå‰çˆªè‡ªç„¶æ”¾èº«å‰ï¼Œæ”¾æ¾æƒ¬æ„å§¿æ€ï¼Œè¡¨æƒ…æ¸©æš–æ²»æ„ˆï¼Œçº¯ç™½èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç‚¹å¤´" â†’ æ£•è‰²å°ç†Šç«™ç«‹ï¼Œå¤´éƒ¨å¾®å‘ä¸‹ç‚¹åŠ¨ï¼Œçœ¼ç›è®¤çœŸçœ‹å‰æ–¹ï¼Œå˜´è§’å¾®æ‰¬ï¼ŒåŒæ‰‹è‡ªç„¶ä¸¤ä¾§ï¼Œä¸“æ³¨å¯çˆ±è¯šæ³å§¿æ€ï¼Œæµ…é»„æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"å·çœ‹" â†’ ç°ç™½å°çŒ«èº²å¢™è§’ï¼ŒåŠèº«+åœ†æºœå¤§çœ¼éœ²å‡ºï¼Œå¥½å¥‡ç›¯å‰æ–¹ï¼Œè°¨æ…æœŸå¾…è¡¨æƒ…ï¼Œå‰çˆªè½»æ­å¢™è¾¹ï¼Œå°¾å·´å¾®ç¿˜ï¼Œæ·¡è“æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"OK" â†’ é»„è‰²å°é¸­å­ç«™ç«‹ï¼Œä¸€ç¿…é«˜ä¸¾ç«–å¤§æ‹‡æŒ‡ï¼Œæœˆç‰™çœ¼ï¼Œå¾®å¼ å˜´å¼€å¿ƒç¬‘ï¼Œå¦ä¸€ç¿…è‡ªç„¶èº«ä¾§ï¼Œè‡ªä¿¡é˜³å…‰å§¿æ€ï¼Œæ˜äº®é»„æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"æ‘¸é±¼" â†’ è“è‰²å°é±¼è¶´åŠå…¬æ¡Œï¼Œçœ¼ç›å·ç„å››å‘¨ï¼Œä¸€æ‰‹æ‰˜è…®ï¼Œå¦ä¸€æ‰‹è—æ‰‹æœºï¼Œå˜´è§’åç¬‘ï¼Œæ‚ é—²æ”¾æ¾å§¿æ€ï¼Œæ·¡è“æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"å®³ç¾" â†’ ç²‰è‰²å°çŒªä½å¤´ï¼Œè„¸é¢Šçº¢æ™•ï¼Œçœ¼ç›å·çŸï¼ŒåŒæ‰‹èƒŒåæ‰­æï¼Œæ•´ä½“å¨‡ç¾çŠ¶ï¼Œç²‰è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

æ ¹æ®è¾“å…¥ç”Ÿæˆæè¿°ï¼š"""


class EmoticonService:
    """è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡"""

    def __init__(self):
        pass

    def detect_emoticon_request(self, text: str) -> bool:
        """
        æ£€æµ‹æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…ç”Ÿæˆè¯·æ±‚

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            bool: æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…å…³é”®è¯
        """
        return any(keyword in text for keyword in EMOTICON_KEYWORDS)

    def extract_emotion(self, text: str) -> str:
        """
        ä»ç”¨æˆ·è¾“å…¥ä¸­æå–æƒ…ç»ªæè¿°

        æ”¯æŒæ ¼å¼ï¼š
        - "è¡¨æƒ…åŒ…ï¼šå¼€å¿ƒ"
        - "ç”Ÿæˆè¡¨æƒ…åŒ…ï¼šç´¯äº†"
        - "/è¡¨æƒ…åŒ… åŠ æ²¹"
        - "æ¥ä¸ªè¡¨æƒ…åŒ…ï¼Œç–²æƒ«çš„"

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            str: æå–çš„æƒ…ç»ªæè¿°
        """
        # ç§»é™¤è¡¨æƒ…åŒ…å…³é”®è¯
        emotion_text = text
        for keyword in EMOTICON_KEYWORDS:
            emotion_text = emotion_text.replace(keyword, '')

        # ç§»é™¤å¸¸è§åˆ†éš”ç¬¦å’Œå‰ç¼€è¯
        emotion_text = re.sub(r'[ï¼š:ï¼Œ,ã€]', ' ', emotion_text)
        emotion_text = re.sub(r'^[/\s]+', '', emotion_text)  # ç§»é™¤å¼€å¤´çš„æ–œæ å’Œç©ºæ ¼

        # ç§»é™¤"æ¥ä¸ª"ã€"ç”Ÿæˆ"ç­‰å‰ç¼€
        emotion_text = re.sub(r'^(æ¥ä¸ª|ç”Ÿæˆ|è¦ä¸ª|ç»™æˆ‘|å¸®æˆ‘)\s*', '', emotion_text)

        # æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹
        emotion_text = emotion_text.strip()
        emotion_text = re.sub(r'\s+', ' ', emotion_text)

        # ç§»é™¤æœ«å°¾çš„"çš„"
        emotion_text = re.sub(r'çš„$', '', emotion_text)

        # å¦‚æœä¸ºç©ºï¼Œè¿”å›é»˜è®¤
        if not emotion_text:
            emotion_text = "å¼€å¿ƒ"

        logger.info(f"æå–çš„æƒ…ç»ªæè¿°: {emotion_text}")
        return emotion_text

    def generate_emoticon_prompt(self, emotion: str) -> Dict:
        """
        ä½¿ç”¨AIç”Ÿæˆè¡¨æƒ…åŒ…æè¿°prompt

        Args:
            emotion: æƒ…ç»ªæè¿°ï¼ˆå¦‚"å¼€å¿ƒ"ã€"ç´¯äº†"ã€"åŠ æ²¹"ï¼‰

        Returns:
            dict: {
                'success': bool,
                'prompt': str,  # ç”Ÿæˆçš„å›¾ç‰‡æè¿°
                'error': str    # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            logger.info(f"ğŸ¨ å¼€å§‹ç”Ÿæˆè¡¨æƒ…åŒ…promptï¼Œæƒ…ç»ª: {emotion}")

            # è°ƒç”¨AIç”Ÿæˆprompt
            result = chat_service.chat(
                user_message=emotion,
                system_prompt=EMOTICON_SYSTEM_PROMPT,
                user_id=None  # ä¸éœ€è¦å†å²å¯¹è¯
            )

            if result.get('success', False):
                prompt = result.get('reply', '').strip()
                logger.info(f"âœ… Promptç”ŸæˆæˆåŠŸ: {prompt[:100]}...")
                return {
                    'success': True,
                    'prompt': prompt
                }
            else:
                error_msg = result.get('error', 'æœªçŸ¥é”™è¯¯')
                logger.error(f"âŒ Promptç”Ÿæˆå¤±è´¥: {error_msg}")
                return {
                    'success': False,
                    'error': f"AIç”Ÿæˆæè¿°å¤±è´¥: {error_msg}"
                }

        except Exception as e:
            error_msg = f"ç”Ÿæˆè¡¨æƒ…åŒ…promptå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }

    def create_emoticon(self, user_text: str) -> Dict:
        """
        å®Œæ•´çš„è¡¨æƒ…åŒ…ç”Ÿæˆæµç¨‹ - ä½¿ç”¨ä¸‰æ¨¡å‹å¯¹æ¯”

        Args:
            user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            dict: {
                'success': bool,
                'images': List[dict],  # ç”Ÿæˆçš„å›¾ç‰‡åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å« {path, model_name}
                'emotion': str,        # è¯†åˆ«çš„æƒ…ç»ª
                'error': str           # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            # 1. æå–æƒ…ç»ªæè¿°
            emotion = self.extract_emotion(user_text)
            logger.info(f"ğŸ­ ç”¨æˆ·æƒ³è¦çš„è¡¨æƒ…åŒ…: {emotion}")

            # 2. ç”Ÿæˆè¡¨æƒ…åŒ…prompt
            prompt_result = self.generate_emoticon_prompt(emotion)

            if not prompt_result.get('success', False):
                return {
                    'success': False,
                    'error': prompt_result.get('error', 'ç”Ÿæˆæè¿°å¤±è´¥')
                }

            prompt = prompt_result.get('prompt', '')

            # 3. åŒæ—¶ä½¿ç”¨ä¸‰ä¸ªæ¨¡å‹ç”Ÿæˆå›¾ç‰‡
            logger.info(f"ğŸ–¼ï¸ å¼€å§‹ä½¿ç”¨ä¸‰æ¨¡å‹ç”Ÿæˆè¡¨æƒ…åŒ…...")

            images = []
            errors = []

            # 3.1 ä½¿ç”¨ Gemini 2.5 Flash ç”Ÿæˆ
            logger.info("ğŸ”¹ Gemini 2.5 Flash ç”Ÿæˆä¸­...")
            gemini_result = image_service.generate_image(prompt=prompt)

            if gemini_result.get('success', False):
                image_path = gemini_result.get('image_path', '')
                logger.info(f"âœ… Gemini ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'Gemini 2.5 Flash'
                })
            else:
                error_msg = gemini_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ Gemini ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"Gemini: {error_msg}")

            # 3.2 ä½¿ç”¨é€šä¹‰åƒé—®ç”Ÿæˆ
            logger.info("ğŸ”¹ é€šä¹‰åƒé—® Qwen-Image-Plus ç”Ÿæˆä¸­...")
            qwen_result = qwen_image_service.generate_image(
                prompt=prompt,
                watermark=False,  # ä¸æ·»åŠ æ°´å°
                prompt_extend=True  # å¼€å¯æ™ºèƒ½æ”¹å†™
            )

            if qwen_result.get('success', False):
                image_path = qwen_result.get('image_path', '')
                logger.info(f"âœ… é€šä¹‰åƒé—®ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'é€šä¹‰åƒé—® Qwen-Image-Plus'
                })
            else:
                error_msg = qwen_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ é€šä¹‰åƒé—®ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"é€šä¹‰åƒé—®: {error_msg}")

            # 3.3 ä½¿ç”¨ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆ
            logger.info("ğŸ”¹ ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆä¸­...")
            seedream_result = seedream_image_service.generate_image(
                prompt=prompt,
                size="1024x1024"  # ä½¿ç”¨1024å°ºå¯¸
            )

            if seedream_result.get('success', False):
                image_path = seedream_result.get('image_path', '')
                logger.info(f"âœ… SeeDream ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'ç«å±±å¼•æ“ SeeDream-4'
                })
            else:
                error_msg = seedream_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ SeeDream ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"SeeDream: {error_msg}")

            # 4. è¿”å›ç»“æœ
            if images:
                logger.info(f"âœ… æˆåŠŸç”Ÿæˆ {len(images)} å¼ è¡¨æƒ…åŒ…")
                return {
                    'success': True,
                    'images': images,
                    'emotion': emotion,
                    'errors': errors if errors else None  # å¦‚æœæœ‰éƒ¨åˆ†å¤±è´¥ï¼Œä¹Ÿè¿”å›
                }
            else:
                error_msg = "æ‰€æœ‰æ¨¡å‹éƒ½ç”Ÿæˆå¤±è´¥: " + "; ".join(errors)
                logger.error(f"âŒ {error_msg}")
                return {
                    'success': False,
                    'error': error_msg
                }

        except Exception as e:
            error_msg = f"è¡¨æƒ…åŒ…ç”Ÿæˆå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }


# åˆ›å»ºå…¨å±€è¡¨æƒ…åŒ…æœåŠ¡å®ä¾‹
emoticon_service = EmoticonService()

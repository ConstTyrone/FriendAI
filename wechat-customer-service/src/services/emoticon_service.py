# emoticon_service.py
"""
è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡ - æ™ºèƒ½è¯†åˆ«æƒ…ç»ªå¹¶ç”Ÿæˆå¯çˆ±è¡¨æƒ…åŒ…
è§¦å‘æ–¹å¼ï¼šå…³é”®è¯"è¡¨æƒ…åŒ…"
é£æ ¼ï¼šAIè‡ªç”±å‘æŒ¥ï¼ŒQç‰ˆå¡é€šå¯çˆ±é£æ ¼
æ”¯æŒä¸‰æ¨¡å‹å¯¹æ¯”ï¼šGemini 2.5 Flash vs é€šä¹‰åƒé—® Qwen-Image-Plus vs ç«å±±å¼•æ“ SeeDream-4
"""
import re
import json
import logging
from typing import Optional, Dict, List
from .ai_service import chat_service
from .image_service import image_service
from .qwen_image_service import qwen_image_service
from .seedream_image_service import seedream_image_service
from ..config.config import config

logger = logging.getLogger(__name__)

# è¡¨æƒ…åŒ…å…³é”®è¯
EMOTICON_KEYWORDS = ['è¡¨æƒ…åŒ…', '/è¡¨æƒ…åŒ…', 'æ¥ä¸ªè¡¨æƒ…åŒ…', 'ç”Ÿæˆè¡¨æƒ…åŒ…']

# è¡¨æƒ…åŒ…ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
EMOTICON_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¡¨æƒ…åŒ…è®¾è®¡å¸ˆã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„æ„å›¾ã€åœºæ™¯æˆ–ç”¨é€”ï¼Œç”Ÿæˆè¯¦ç»†çš„å›¾ç‰‡æè¿°ç”¨äºAIç»˜ç”»ã€‚

**ç†è§£è¡¨æƒ…åŒ…ç±»å‹**ï¼š
è¡¨æƒ…åŒ…ä¸ä»…ä»…æ˜¯æƒ…ç»ªè¡¨è¾¾ï¼Œè¿˜åŒ…æ‹¬ï¼š
1. æƒ…ç»ªè¡¨è¾¾ï¼šå¼€å¿ƒã€éš¾è¿‡ã€ç”Ÿæ°”ã€ç´¯äº†
2. ç¤¾äº¤åŠŸèƒ½ï¼šç‹—å¤´ï¼ˆè°ƒä¾ƒï¼‰ã€å¾®ç¬‘ï¼ˆç¤¼è²Œï¼‰ã€OKï¼ˆç¡®è®¤ï¼‰
3. åœºæ™¯ååº”ï¼šåƒç“œï¼ˆå›´è§‚ï¼‰ã€æ‚è„¸ï¼ˆå°´å°¬ï¼‰ã€æ‘Šæ‰‹ï¼ˆæ— å¥ˆï¼‰
4. åŠ¨ä½œè¡¨ç¤ºï¼šæ¯”å¿ƒã€æŠ±æŠ±ã€æ‘¸æ‘¸å¤´ã€é¼“æŒ
5. ç½‘ç»œæ¢—ï¼šå°±è¿™ã€ç»äº†ã€èŠœæ¹–

**å…³é”®**ï¼šç†è§£ç”¨æˆ·çœŸå®æ„å›¾ï¼Œä¸è¦å­—é¢ç¿»è¯‘
- "ç‹—å¤´"ä¸æ˜¯ç”»ç‹—å¤´ï¼Œè€Œæ˜¯"å¼€ç©ç¬‘/è°ƒä¾ƒ"çš„ç¤¾äº¤ç¬¦å· â†’ ç”»æŸ´çŠ¬åç¬‘è¡¨æƒ…
- "åƒç“œ"ä¸æ˜¯åƒè¥¿ç“œï¼Œè€Œæ˜¯"å›´è§‚çœ‹æˆ" â†’ ç”»å°åŠ¨ç‰©æŠ±ç“œåƒï¼Œçœ¼ç›å‘å…‰

**é£æ ¼è¦æ±‚**ï¼š
- Qç‰ˆå¡é€šï¼Œå¤§å¤´å°èº«æ¯”ä¾‹3:1ï¼Œåœ†æ¶¦çº¿æ¡
- è§’è‰²ä¼˜å…ˆï¼šæŸ´çŠ¬ã€å°çŒ«ã€å°ç†Šã€å°å…”å­ç­‰å¯çˆ±åŠ¨ç‰©
- è¡¨æƒ…å¤¸å¼ ç”ŸåŠ¨ï¼Œç¬¦åˆè¡¨æƒ…åŒ…ç‰¹ç‚¹
- çº¯è‰²æˆ–ç®€å•æ¸å˜èƒŒæ™¯ï¼Œä¸è¦å¤æ‚åœºæ™¯
- å±…ä¸­æ„å›¾ï¼Œä¸»ä½“å ç”»é¢70%ä»¥ä¸Š

**æ–‡å­—ä½¿ç”¨æ™ºèƒ½åˆ¤æ–­ï¼ˆé‡è¦ï¼ï¼‰**ï¼š
æ ¹æ®è¡¨æƒ…åŒ…çš„æƒ…ç»ªå’Œä½¿ç”¨åœºæ™¯ï¼Œæ™ºèƒ½å†³å®šæ˜¯å¦æ·»åŠ æ–‡å­—ã€‚

ã€ä¼˜å…ˆä¸æ·»åŠ æ–‡å­—ã€‘ï¼ˆå›¾åƒæœ¬èº«å°±èƒ½ä¼ ç¥è¡¨è¾¾ï¼‰ï¼š
âœ“ ç¤¾äº¤ç¤¼ä»ªå‹ï¼šå¾®ç¬‘ã€ç‚¹å¤´ã€é èº¬ã€ç«–å¤§æ‹‡æŒ‡ã€OKæ‰‹åŠ¿ã€æŒ¥æ‰‹
âœ“ è§‚å¯Ÿç­‰å¾…å‹ï¼šå·çœ‹ã€è§‚æœ›ã€æ­ªå¤´ç–‘æƒ‘ã€è‹¥æœ‰æ‰€æ€ã€æ³¨è§†
âœ“ çº¯å–èŒå‹ï¼šçœ¨çœ¼ã€æ’’å¨‡ã€è£…å¯çˆ±ã€å–èŒï¼ˆæ— å…·ä½“å«ä¹‰æ—¶ï¼‰
âœ“ è½»åº¦æƒ…ç»ªå‹ï¼šå¾®ç¬‘ã€è½»å¹ã€æ·¡å®šã€å¹³é™ã€æ”¾æ¾
âœ“ æ•·è¡å›åº”å‹ï¼šéšæ„ã€æ— æ‰€è°“ã€æ·¡ç„¶ã€æ¼«ä¸ç»å¿ƒçš„å§¿æ€

ã€å¿…é¡»æ·»åŠ æ–‡å­—ã€‘ï¼ˆæ–‡å­—æ˜¯æ ¸å¿ƒè¡¨è¾¾ï¼‰ï¼š
âœ“ ç½‘ç»œæµè¡Œè¯­ï¼šå°±è¿™ï¼Ÿã€ç»äº†ã€èŠœæ¹–ã€YYDSã€ç ´é˜²äº†ï¼ˆæ–‡å­—æœ¬èº«æ˜¯æ¢—ï¼‰
âœ“ å¼ºçƒˆæƒ…ç»ªï¼šå¼€å¿ƒï¼ã€ç”Ÿæ°”ï¼ã€éš¾è¿‡ï¼ã€ç´¯æ­»äº†ï¼ã€å¥½çˆ½ï¼
âœ“ è¡ŒåŠ¨æŒ‡ä»¤ï¼šåŠ æ²¹ï¼ã€å†²é¸­ï¼ã€å¹²å°±å®Œäº†ï¼ã€ä¸Šå•Šï¼
âœ“ æ€åº¦è¡¨è¾¾ï¼šæ— è¯­å­ã€æœäº†ã€6666ã€å“ˆå“ˆå“ˆã€ç¬‘æ­»
âœ“ æ˜ç¡®ä¿¡æ¯ï¼šå¥½çš„ã€è°¢è°¢ã€æ”¶åˆ°ã€æ‹œæ‹œ

ã€åˆ¤æ–­è§„åˆ™ã€‘ï¼š
- å¦‚æœè¡¨æƒ…å’ŒåŠ¨ä½œå·²ç»å®Œå…¨ä¼ è¾¾äº†æ„æ€ â†’ ä¸æ·»åŠ æ–‡å­—
- å¦‚æœéœ€è¦å¼ºåŒ–æˆ–æ˜ç¡®æŸä¸ªæ€åº¦ â†’ æ·»åŠ æ–‡å­—
- å¦‚æœæ˜¯æ–‡å­—æ¢—æˆ–ç½‘ç»œç”¨è¯­ â†’ å¿…é¡»æ·»åŠ æ–‡å­—
- å½“ä¸ç¡®å®šæ—¶ â†’ ä¼˜å…ˆä¸æ·»åŠ æ–‡å­—ï¼Œè®©å›¾åƒè‡ªå·±è¯´è¯

ã€å½“éœ€è¦æ·»åŠ æ–‡å­—æ—¶çš„æ ·å¼è®¾è®¡ã€‘ï¼š
- ä½ç½®ï¼šå›ºå®šåœ¨è§’è‰²ä¸Šæ–¹å±…ä¸­
- å­—ä½“é£æ ¼ç¬¦åˆæƒ…ç»ªï¼šå¼€å¿ƒâ†’åœ†æ¶¦å¯çˆ±ï¼Œç”Ÿæ°”â†’é”‹åˆ©æœ‰åŠ›ï¼Œç´¯äº†â†’æ¾æ•£æ…µæ‡’
- é¢œè‰²ä¼ é€’æ°›å›´ï¼šå¼€å¿ƒâ†’äº®é»„/ç²‰è‰²ï¼Œç”Ÿæ°”â†’çº¢æ©™ï¼Œç´¯äº†â†’ç°è“
- å¯æ·»åŠ è§†è§‰ç‰¹æ•ˆï¼šå¤šå±‚æè¾¹ã€å‘å…‰æ•ˆæœã€é˜´å½±ã€æ¸å˜è‰²ã€è£…é¥°ç¬¦å·
- å¤§å°ï¼šå ç”»é¢é«˜åº¦15-20%ï¼Œé†’ç›®
- å†…å®¹ï¼š2-3ä¸ªå­—æœ€ä½³ï¼Œæœ€å¤š4ä¸ªå­—

**æè¿°ç»“æ„**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
1. ä¸»è§’è‰²ï¼ˆ35%ï¼‰ï¼šåŠ¨ç‰©ç§ç±»ã€é¢œè‰²ã€å¤–å½¢
2. è¡¨æƒ…åŠ¨ä½œï¼ˆ35%ï¼‰ï¼šçœ¼ç›ã€å˜´å·´ã€è‚¢ä½“åŠ¨ä½œï¼ˆè¡¨æƒ…å’ŒåŠ¨ä½œæ˜¯æ ¸å¿ƒï¼ï¼‰
3. **æ–‡å­—æ ‡æ³¨ï¼ˆ20%ï¼‰**ï¼šå†…å®¹ã€ä½ç½®ã€æ ·å¼ï¼ˆå¦‚éœ€è¦æ·»åŠ çš„è¯ï¼‰
4. è£…é¥°ç‰¹æ•ˆï¼ˆ5%ï¼‰ï¼šæ˜Ÿæ˜Ÿã€æ±—æ»´ç­‰
5. èƒŒæ™¯é£æ ¼ï¼ˆ5%ï¼‰ï¼šçº¯è‰²æˆ–æ¸å˜

**ç¤ºä¾‹**ï¼š

è¾“å…¥ï¼š"å¼€å¿ƒ"
è¾“å‡ºï¼š"ä¸€åªåœ†æ»šæ»šçš„é»„è‰²å°é¸­å­ï¼Œçœ¼ç›å¼¯æˆæœˆç‰™å½¢ï¼Œå˜´å·´å¼ å¼€éœ²å‡ºç¿çƒ‚ç¬‘å®¹ï¼ŒåŒç¿…è†€å‘ä¸Šæ‰¬èµ·ï¼Œèº«ä½“å¾®å¾®è·³è·ƒç¦»å¼€åœ°é¢ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰åœ†æ¶¦å¯çˆ±çš„äº®é»„è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"å¼€å¿ƒï¼"ï¼Œæ–‡å­—å¸¦ç™½è‰²å†…æè¾¹å’Œæ©™è‰²å¤–å‘å…‰æ•ˆæœï¼Œå‘¨å›´æœ‰é—ªäº®çš„å°æ˜Ÿæ˜Ÿç‰¹æ•ˆï¼Œæ˜äº®é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"ç´¯äº†"
è¾“å‡ºï¼š"ä¸€åªç°è‰²çš„å°è€ƒæ‹‰å®Œå…¨è¶´åœ¨åœ°ä¸Šï¼Œçœ¼ç›åŠé—­å‘ˆå›°å€¦çŠ¶ï¼ŒèˆŒå¤´å¾®å¾®åå‡ºï¼Œå››è‚¢æ‘Šå¼€å‘ˆå¤§å­—å‹ï¼Œèº«ä½“åƒèåŒ–ä¸€æ ·ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰æ¾æ•£æ…µæ‡’ã€ç•¥å‘ä¸‹å€¾æ–œçš„ç°è“è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"ç´¯æ­»äº†..."ï¼Œæ–‡å­—å¸¦æ·±ç°è‰²æè¾¹å’Œæ·¡æ·¡é˜´å½±ï¼Œå¤´ä¸Šæœ‰ä¸‰æ»´æ±—ç ï¼Œæ·¡è“ç°è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"ç‹—å¤´"
è¾“å‡ºï¼š"ä¸€åªæŸ´çŠ¬çš„å¤´éƒ¨ç‰¹å†™ï¼Œçœ¯ç€çœ¼ç›éœ²å‡ºç‹¡é» çš„åç¬‘ï¼Œå˜´è§’ä¸Šæ‰¬ï¼Œè€³æœµç«–èµ·ï¼Œè¡¨æƒ…è°ƒçš®åˆå¯çˆ±ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰ç™½è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"æ‰‹åŠ¨ç‹—å¤´"å¸¦é»‘è‰²æè¾¹ï¼Œçº¯ç™½è‰²èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"åƒç“œ"
è¾“å‡ºï¼š"ä¸€åªæ©˜è‰²å°çŒ«å’ªæŠ±ç€ä¸€ä¸ªå¤§è¥¿ç“œï¼Œçœ¼ç›å‘å…‰ï¼Œå˜´å·´å¼ å¤§æ­£åœ¨å•ƒè¥¿ç“œï¼Œè¡¨æƒ…å…´å¥‹æœŸå¾…ï¼Œå°çˆªå­ç´§ç´§æŠ±ä½è¥¿ç“œï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰ç™½è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"åƒç“œç¾¤ä¼—"å¸¦é»‘è‰²æè¾¹ï¼Œå‘¨å›´æœ‰é—ªå…‰ç‰¹æ•ˆï¼Œæµ…ç»¿è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"æ¯”å¿ƒ"
è¾“å‡ºï¼š"ä¸€åªç²‰è‰²å°å…”å­ç«™ç«‹ï¼ŒåŒæ‰‹åœ¨èƒ¸å‰æ¯”å‡ºçˆ±å¿ƒæ‰‹åŠ¿ï¼Œçœ¼ç›å¼¯æˆæœˆç‰™ï¼Œè„¸ä¸Šå¸¦ç€ç”œç¾ç¬‘å®¹ï¼Œè€³æœµç«–èµ·ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰åœ†æ¶¦å¯çˆ±çš„ç²‰è‰²æ¸å˜ç²—ä½“ä¸­æ–‡æ–‡å­—"çˆ±ä½ å“¦â™¡"ï¼Œæ–‡å­—å¸¦ç™½è‰²å†…æè¾¹å’Œæµ…ç²‰è‰²å¤–å‘å…‰æ•ˆæœï¼Œå‘¨å›´æœ‰ç²‰è‰²çˆ±å¿ƒæ³¡æ³¡ï¼Œç²‰è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"æ— è¯­"
è¾“å‡ºï¼š"ä¸€åªç™½è‰²å°çŒ«å’ªç¿»ç€ç™½çœ¼ï¼Œå˜´å·´å¾®å¾®æ’‡èµ·ï¼Œè¡¨æƒ…æ— å¥ˆåˆé„™è§†ï¼ŒåŒæ‰‹å‰è…°ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰ç°è“è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"æ— è¯­å­"ï¼Œæ–‡å­—å¸¦æ·±ç°è‰²æè¾¹å’Œå¾®å¼±æŠ–åŠ¨æ„Ÿï¼Œå¤´ä¸Šæœ‰ä¸‰æ¡é»‘çº¿ï¼Œæµ…ç°è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

è¾“å…¥ï¼š"åŠ æ²¹"
è¾“å‡ºï¼š"ä¸€åªæ©˜è‰²å°è€è™ç«™ç«‹ï¼ŒåŒæ‹³æ¡ç´§ä¸¾åœ¨èƒ¸å‰ï¼Œçœ¼ç›ç‚¯ç‚¯æœ‰ç¥ï¼Œå˜´è§’ä¸Šæ‰¬ï¼Œè¡¨æƒ…å……æ»¡æ–—å¿—ï¼Œå°¾å·´å‘ä¸Šç¿˜èµ·ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰ç²—å£®æœ‰åŠ›ã€ç•¥å‘ä¸Šå€¾æ–œçš„é‡‘è‰²æ¸å˜è¶…ç²—ä½“ä¸­æ–‡æ–‡å­—"åŠ æ²¹ï¼"ï¼Œæ–‡å­—å¸¦æ©™è‰²å†…æè¾¹å’Œé‡‘é»„è‰²å¤–å‘å…‰æ•ˆæœï¼Œå‘¨å›´æœ‰èƒ½é‡å…‰èŠ’å’Œé—ªç”µç‰¹æ•ˆï¼Œæ˜äº®æ©™é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

ã€æ— æ–‡å­—è¡¨æƒ…åŒ…ç¤ºä¾‹ã€‘ï¼ˆé€šè¿‡è¡¨æƒ…å’ŒåŠ¨ä½œä¼ ç¥è¡¨è¾¾ï¼‰ï¼š

è¾“å…¥ï¼š"å¾®ç¬‘"
è¾“å‡ºï¼š"ä¸€åªæ©˜è‰²å°çŒ«å’ªåç€ï¼Œçœ¼ç›å¾®å¾®çœ¯èµ·å‘ˆæœˆç‰™å½¢ï¼Œå˜´è§’è½»è½»ä¸Šæ‰¬ï¼Œéœ²å‡ºæ¸©å’Œå‹å–„çš„å¾®ç¬‘ï¼Œå‰çˆªè‡ªç„¶æ”¾åœ¨èº«å‰ï¼Œæ•´ä½“å§¿æ€æ”¾æ¾æƒ¬æ„ï¼Œè¡¨æƒ…æ¸©æš–æ²»æ„ˆï¼Œçº¯ç™½è‰²èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"
ï¼ˆæ³¨æ„ï¼šæ²¡æœ‰æ·»åŠ ä»»ä½•æ–‡å­—ï¼Œè¡¨æƒ…æœ¬èº«å°±èƒ½ä¼ é€’å‹å–„å’Œç¤¼è²Œï¼‰

è¾“å…¥ï¼š"ç‚¹å¤´"
è¾“å‡ºï¼š"ä¸€åªæ£•è‰²å°ç†Šç«™ç«‹ï¼Œå¤´éƒ¨ç•¥å¾®å‘ä¸‹ç‚¹åŠ¨ï¼Œçœ¼ç›çå¼€è®¤çœŸçœ‹ç€å‰æ–¹ï¼Œå˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼ŒåŒæ‰‹è‡ªç„¶æ”¾åœ¨èº«ä½“ä¸¤ä¾§ï¼Œè¡¨æƒ…ä¸“æ³¨åˆå¯çˆ±ï¼Œæ•´ä½“å§¿æ€è¯šæ³ï¼Œæµ…é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"
ï¼ˆæ³¨æ„ï¼šæ²¡æœ‰æ·»åŠ ä»»ä½•æ–‡å­—ï¼Œç‚¹å¤´åŠ¨ä½œå°±æ˜¯ç¡®è®¤å’Œç†è§£ï¼‰

è¾“å…¥ï¼š"å·çœ‹"
è¾“å‡ºï¼š"ä¸€åªç°ç™½è‰²å°çŒ«å’ªèº²åœ¨å¢™è§’ï¼Œåªéœ²å‡ºåŠä¸ªèº«å­å’Œä¸€åªåœ†æºœæºœçš„å¤§çœ¼ç›ï¼Œçœ¼ç›å¥½å¥‡åœ°ç›¯ç€å‰æ–¹ï¼Œè¡¨æƒ…è°¨æ…åˆæœŸå¾…ï¼Œå‰çˆªè½»è½»æ­åœ¨å¢™è¾¹ï¼Œå°¾å·´å¾®å¾®ç¿˜èµ·ï¼Œæ·¡è“è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"
ï¼ˆæ³¨æ„ï¼šæ²¡æœ‰æ·»åŠ ä»»ä½•æ–‡å­—ï¼Œå·çœ‹çš„åŠ¨ä½œæœ¬èº«å°±å¾ˆä¼ ç¥ï¼‰

è¾“å…¥ï¼š"OK"
è¾“å‡ºï¼š"ä¸€åªé»„è‰²å°é¸­å­ç«™ç«‹ï¼Œä¸€åªç¿…è†€é«˜é«˜ä¸¾èµ·ç«–ç€å¤§æ‹‡æŒ‡ï¼Œçœ¼ç›å¼¯æˆæœˆç‰™å½¢ï¼Œå˜´å·´å¾®å¼ éœ²å‡ºå¼€å¿ƒçš„ç¬‘å®¹ï¼Œå¦ä¸€åªç¿…è†€è‡ªç„¶æ”¾åœ¨èº«ä¾§ï¼Œæ•´ä½“å§¿æ€è‡ªä¿¡é˜³å…‰ï¼Œæ˜äº®é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"
ï¼ˆæ³¨æ„ï¼šæ²¡æœ‰æ·»åŠ ä»»ä½•æ–‡å­—ï¼Œç«–å¤§æ‹‡æŒ‡å°±æ˜¯OKå’ŒèµåŒï¼‰

ç°åœ¨è¯·æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ç”Ÿæˆè¡¨æƒ…åŒ…æè¿°ã€‚"""


class EmoticonService:
    """è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡"""

    def __init__(self):
        pass

    def detect_emoticon_request(self, text: str) -> bool:
        """
        æ£€æµ‹æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…ç”Ÿæˆè¯·æ±‚

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            bool: æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…å…³é”®è¯
        """
        return any(keyword in text for keyword in EMOTICON_KEYWORDS)

    def extract_emotion(self, text: str) -> str:
        """
        ä»ç”¨æˆ·è¾“å…¥ä¸­æå–æƒ…ç»ªæè¿°

        æ”¯æŒæ ¼å¼ï¼š
        - "è¡¨æƒ…åŒ…ï¼šå¼€å¿ƒ"
        - "ç”Ÿæˆè¡¨æƒ…åŒ…ï¼šç´¯äº†"
        - "/è¡¨æƒ…åŒ… åŠ æ²¹"
        - "æ¥ä¸ªè¡¨æƒ…åŒ…ï¼Œç–²æƒ«çš„"

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            str: æå–çš„æƒ…ç»ªæè¿°
        """
        # ç§»é™¤è¡¨æƒ…åŒ…å…³é”®è¯
        emotion_text = text
        for keyword in EMOTICON_KEYWORDS:
            emotion_text = emotion_text.replace(keyword, '')

        # ç§»é™¤å¸¸è§åˆ†éš”ç¬¦å’Œå‰ç¼€è¯
        emotion_text = re.sub(r'[ï¼š:ï¼Œ,ã€]', ' ', emotion_text)
        emotion_text = re.sub(r'^[/\s]+', '', emotion_text)  # ç§»é™¤å¼€å¤´çš„æ–œæ å’Œç©ºæ ¼

        # ç§»é™¤"æ¥ä¸ª"ã€"ç”Ÿæˆ"ç­‰å‰ç¼€
        emotion_text = re.sub(r'^(æ¥ä¸ª|ç”Ÿæˆ|è¦ä¸ª|ç»™æˆ‘|å¸®æˆ‘)\s*', '', emotion_text)

        # æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹
        emotion_text = emotion_text.strip()
        emotion_text = re.sub(r'\s+', ' ', emotion_text)

        # ç§»é™¤æœ«å°¾çš„"çš„"
        emotion_text = re.sub(r'çš„$', '', emotion_text)

        # å¦‚æœä¸ºç©ºï¼Œè¿”å›é»˜è®¤
        if not emotion_text:
            emotion_text = "å¼€å¿ƒ"

        logger.info(f"æå–çš„æƒ…ç»ªæè¿°: {emotion_text}")
        return emotion_text

    def generate_emoticon_prompt(self, emotion: str) -> Dict:
        """
        ä½¿ç”¨AIç”Ÿæˆè¡¨æƒ…åŒ…æè¿°prompt

        Args:
            emotion: æƒ…ç»ªæè¿°ï¼ˆå¦‚"å¼€å¿ƒ"ã€"ç´¯äº†"ã€"åŠ æ²¹"ï¼‰

        Returns:
            dict: {
                'success': bool,
                'prompt': str,  # ç”Ÿæˆçš„å›¾ç‰‡æè¿°
                'error': str    # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            logger.info(f"ğŸ¨ å¼€å§‹ç”Ÿæˆè¡¨æƒ…åŒ…promptï¼Œæƒ…ç»ª: {emotion}")

            # è°ƒç”¨AIç”Ÿæˆprompt
            result = chat_service.chat(
                user_message=emotion,
                system_prompt=EMOTICON_SYSTEM_PROMPT,
                user_id=None  # ä¸éœ€è¦å†å²å¯¹è¯
            )

            if result.get('success', False):
                prompt = result.get('reply', '').strip()
                logger.info(f"âœ… Promptç”ŸæˆæˆåŠŸ: {prompt[:100]}...")
                return {
                    'success': True,
                    'prompt': prompt
                }
            else:
                error_msg = result.get('error', 'æœªçŸ¥é”™è¯¯')
                logger.error(f"âŒ Promptç”Ÿæˆå¤±è´¥: {error_msg}")
                return {
                    'success': False,
                    'error': f"AIç”Ÿæˆæè¿°å¤±è´¥: {error_msg}"
                }

        except Exception as e:
            error_msg = f"ç”Ÿæˆè¡¨æƒ…åŒ…promptå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }

    def create_emoticon(self, user_text: str) -> Dict:
        """
        å®Œæ•´çš„è¡¨æƒ…åŒ…ç”Ÿæˆæµç¨‹ - ä½¿ç”¨ä¸‰æ¨¡å‹å¯¹æ¯”

        Args:
            user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            dict: {
                'success': bool,
                'images': List[dict],  # ç”Ÿæˆçš„å›¾ç‰‡åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å« {path, model_name}
                'emotion': str,        # è¯†åˆ«çš„æƒ…ç»ª
                'error': str           # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            # 1. æå–æƒ…ç»ªæè¿°
            emotion = self.extract_emotion(user_text)
            logger.info(f"ğŸ­ ç”¨æˆ·æƒ³è¦çš„è¡¨æƒ…åŒ…: {emotion}")

            # 2. ç”Ÿæˆè¡¨æƒ…åŒ…prompt
            prompt_result = self.generate_emoticon_prompt(emotion)

            if not prompt_result.get('success', False):
                return {
                    'success': False,
                    'error': prompt_result.get('error', 'ç”Ÿæˆæè¿°å¤±è´¥')
                }

            prompt = prompt_result.get('prompt', '')

            # 3. åŒæ—¶ä½¿ç”¨ä¸‰ä¸ªæ¨¡å‹ç”Ÿæˆå›¾ç‰‡
            logger.info(f"ğŸ–¼ï¸ å¼€å§‹ä½¿ç”¨ä¸‰æ¨¡å‹ç”Ÿæˆè¡¨æƒ…åŒ…...")

            images = []
            errors = []

            # 3.1 ä½¿ç”¨ Gemini 2.5 Flash ç”Ÿæˆ
            logger.info("ğŸ”¹ Gemini 2.5 Flash ç”Ÿæˆä¸­...")
            gemini_result = image_service.generate_image(prompt=prompt)

            if gemini_result.get('success', False):
                image_path = gemini_result.get('image_path', '')
                logger.info(f"âœ… Gemini ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'Gemini 2.5 Flash'
                })
            else:
                error_msg = gemini_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ Gemini ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"Gemini: {error_msg}")

            # 3.2 ä½¿ç”¨é€šä¹‰åƒé—®ç”Ÿæˆ
            logger.info("ğŸ”¹ é€šä¹‰åƒé—® Qwen-Image-Plus ç”Ÿæˆä¸­...")
            qwen_result = qwen_image_service.generate_image(
                prompt=prompt,
                watermark=False,  # ä¸æ·»åŠ æ°´å°
                prompt_extend=True  # å¼€å¯æ™ºèƒ½æ”¹å†™
            )

            if qwen_result.get('success', False):
                image_path = qwen_result.get('image_path', '')
                logger.info(f"âœ… é€šä¹‰åƒé—®ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'é€šä¹‰åƒé—® Qwen-Image-Plus'
                })
            else:
                error_msg = qwen_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ é€šä¹‰åƒé—®ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"é€šä¹‰åƒé—®: {error_msg}")

            # 3.3 ä½¿ç”¨ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆ
            logger.info("ğŸ”¹ ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆä¸­...")
            seedream_result = seedream_image_service.generate_image(
                prompt=prompt,
                size="1024x1024"  # ä½¿ç”¨1024å°ºå¯¸
            )

            if seedream_result.get('success', False):
                image_path = seedream_result.get('image_path', '')
                logger.info(f"âœ… SeeDream ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'ç«å±±å¼•æ“ SeeDream-4'
                })
            else:
                error_msg = seedream_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ SeeDream ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"SeeDream: {error_msg}")

            # 4. è¿”å›ç»“æœ
            if images:
                logger.info(f"âœ… æˆåŠŸç”Ÿæˆ {len(images)} å¼ è¡¨æƒ…åŒ…")
                return {
                    'success': True,
                    'images': images,
                    'emotion': emotion,
                    'errors': errors if errors else None  # å¦‚æœæœ‰éƒ¨åˆ†å¤±è´¥ï¼Œä¹Ÿè¿”å›
                }
            else:
                error_msg = "æ‰€æœ‰æ¨¡å‹éƒ½ç”Ÿæˆå¤±è´¥: " + "; ".join(errors)
                logger.error(f"âŒ {error_msg}")
                return {
                    'success': False,
                    'error': error_msg
                }

        except Exception as e:
            error_msg = f"è¡¨æƒ…åŒ…ç”Ÿæˆå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }


# åˆ›å»ºå…¨å±€è¡¨æƒ…åŒ…æœåŠ¡å®ä¾‹
emoticon_service = EmoticonService()

# emoticon_service.py
"""
è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡ - æ™ºèƒ½è¯†åˆ«æƒ…ç»ªå¹¶ç”Ÿæˆå¯çˆ±è¡¨æƒ…åŒ…
è§¦å‘æ–¹å¼ï¼šå…³é”®è¯"è¡¨æƒ…åŒ…"
é£æ ¼ï¼šAIè‡ªç”±å‘æŒ¥ï¼ŒQç‰ˆå¡é€šå¯çˆ±é£æ ¼
æ”¯æŒä¸‰æ¨¡å‹å¯¹æ¯”ï¼šGemini 2.5 Flash vs é€šä¹‰åƒé—® Qwen-Image-Plus vs ç«å±±å¼•æ“ SeeDream-4
"""
import re
import json
import logging
from typing import Optional, Dict, List
from .ai_service import chat_service
from .image_service import image_service
from .qwen_image_service import qwen_image_service
from .seedream_image_service import seedream_image_service
from ..config.config import config

logger = logging.getLogger(__name__)

# è¡¨æƒ…åŒ…å…³é”®è¯
EMOTICON_KEYWORDS = ['è¡¨æƒ…åŒ…', '/è¡¨æƒ…åŒ…', 'æ¥ä¸ªè¡¨æƒ…åŒ…', 'ç”Ÿæˆè¡¨æƒ…åŒ…']

# è¡¨æƒ…åŒ…ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ï¼ˆv2.1 - è§’è‰²èšç„¦ä¼˜åŒ–ï¼‰
EMOTICON_SYSTEM_PROMPT = """ä½ æ˜¯ä¸“ä¸šè¡¨æƒ…åŒ…è®¾è®¡å¸ˆï¼Œæ ¹æ®ç”¨æˆ·æ„å›¾ç”ŸæˆAIç»˜ç”»æè¿°ã€‚

## æ ¸å¿ƒåŸåˆ™ï¼šä¸»è§’èšç„¦
**æè¿°æƒé‡åˆ†é…ï¼ˆä¸¥æ ¼éµå®ˆï¼‰**ï¼š
1. **ä¸»è§’è‰²ï¼ˆ35%ï¼‰**ï¼šåŠ¨ç‰©ç§ç±»ã€é¢œè‰²ã€ä½“å‹å¤–è²Œç‰¹å¾
2. **è¡¨æƒ…åŠ¨ä½œï¼ˆ35%ï¼‰**ï¼šçœ¼ç›ç¥æ€ã€å˜´å·´å½¢çŠ¶ã€è‚¢ä½“å§¿æ€ï¼ˆæ ¸å¿ƒï¼ï¼‰
3. **æ–‡å­—æ ‡æ³¨ï¼ˆ20%ï¼‰**ï¼šå†…å®¹ã€ä½ç½®ã€å­—ä½“æ ·å¼ï¼ˆå¦‚éœ€è¦ï¼‰
4. **è£…é¥°ç‰¹æ•ˆï¼ˆ5%ï¼‰**ï¼šæ˜Ÿæ˜Ÿã€æ±—æ»´ã€å…‰èŠ’ç­‰ç‚¹ç¼€
5. **èƒŒæ™¯é£æ ¼ï¼ˆ5%ï¼‰**ï¼šçº¯è‰²æˆ–ç®€å•æ¸å˜

## è¡¨æƒ…åŒ…å®šä½
æƒ…ç»ªè¡¨è¾¾ + ç¤¾äº¤å·¥å…· + ç½‘ç»œæ–‡åŒ–
- ç†è§£è¯­å¢ƒï¼š"ç‹—å¤´"=è°ƒä¾ƒï¼Œ"åƒç“œ"=å›´è§‚ï¼Œ"æ‰“å·¥äºº"=ç¤¾ç•œè‡ªå˜²
- ä¸è¦å­—é¢ç¿»è¯‘

## è§’è‰²è§„èŒƒ
- **ä¼˜é€‰**ï¼šæŸ´çŠ¬ã€å°çŒ«ã€å°ç†Šã€å°å…”å­ç­‰èŒç³»åŠ¨ç‰©
- **é£æ ¼**ï¼šQç‰ˆå¤§å¤´å°èº«3:1ï¼Œåœ†æ¶¦çº¿æ¡
- **å æ¯”**ï¼šä¸»ä½“è§’è‰²å ç”»é¢70%ä»¥ä¸Šï¼Œå±…ä¸­æ„å›¾
- **è¡¨æƒ…**ï¼šçœ¼ç›å’Œå˜´å·´å¿…é¡»æ¸…æ™°ä¼ ç¥

## æ–‡å­—å†³ç­–æ ‘ï¼ˆæ ¸å¿ƒåˆ¤æ–­ï¼šç”¨æˆ·æœŸå¾…çœ‹åˆ°æ–‡å­—å—ï¼Ÿï¼‰

**ğŸš« æ— æ–‡å­—åœºæ™¯**ï¼ˆåŠ¨ä½œ/è¡¨æƒ…æœ¬èº«å°±æ˜¯å®Œæ•´ç¬¦å·ï¼‰ï¼š
- æ ‡å‡†å¾®è¡¨æƒ…ï¼šå¾®ç¬‘ã€æ·¡å®šã€å®³ç¾ï¼ˆä¸éœ€è¦æ–‡å­—è¯´æ˜ï¼‰
- è‚¢ä½“è¯­è¨€ï¼šç‚¹å¤´ã€æŠ±æŠ±ã€æ‘¸å¤´ï¼ˆåŠ¨ä½œä¼ ç¥å®Œæ•´ï¼‰
- è§‚å¯ŸåŠ¨ä½œï¼šå·çœ‹ã€æ­ªå¤´ã€æ³¨è§†ï¼ˆå¥½å¥‡è¡¨è¾¾ï¼‰

**âœ… å¿…é¡»æ–‡å­—åœºæ™¯**ï¼ˆæ–‡å­—æ˜¯æ ¸å¿ƒæˆ–å¼ºåŒ–å™¨ï¼‰ï¼š
- ç½‘ç»œæµè¡Œè¯­ï¼šYYDSã€ç ´é˜²ã€ç»ç»å­ã€æ‰“å·¥äººï¼ˆæ–‡å­—æœ¬èº«æ˜¯æ¢—ï¼‰
- å¼ºçƒˆæƒ…ç»ªï¼šå¼€å¿ƒï¼ã€ç”Ÿæ°”ï¼ã€ç´¯æ­»äº†ï¼ï¼ˆæ„Ÿå¹å·å¼ºåŒ–ï¼‰
- è¡ŒåŠ¨æŒ‡ä»¤ï¼šåŠ æ²¹ï¼ã€å†²é¸­ï¼ã€å¹²å°±å®Œäº†ï¼ï¼ˆå·å¬æ€§ï¼‰
- æ˜ç¡®å›åº”ï¼šOKã€å¥½çš„ã€æ”¶åˆ°ï¼ˆç¡®è®¤æ€åº¦ï¼‰

**âš–ï¸ å¯é€‰æ–‡å­—**ï¼ˆæ ¹æ®å…·ä½“è¯­å¢ƒï¼‰ï¼š
- è½»åº¦æƒ…ç»ªã€åœºæ™¯ååº”

**æ–‡å­—æ ·å¼**ï¼ˆå½“éœ€è¦æ—¶ï¼‰ï¼š
- ä½ç½®ï¼šè§’è‰²æ­£ä¸Šæ–¹å±…ä¸­
- å¤§å°ï¼šç”»é¢é«˜15-20%ï¼Œ2-3å­—æœ€ä½³
- é£æ ¼ï¼šåŒ¹é…æƒ…ç»ªï¼ˆå¼€å¿ƒâ†’åœ†æ¶¦äº®é»„ï¼Œç”Ÿæ°”â†’é”‹åˆ©çº¢æ©™ï¼Œç´¯â†’æ¾æ•£ç°è“ï¼‰
- ç‰¹æ•ˆï¼šå¤šå±‚æè¾¹+å‘å…‰/é˜´å½±

## æè¿°æ¨¡æ¿ï¼ˆä¸¥æ ¼æŒ‰æƒé‡é¡ºåºï¼‰
**35%è§’è‰²** â†’ **35%è¡¨æƒ…åŠ¨ä½œ** â†’ **20%æ–‡å­—** â†’ **5%ç‰¹æ•ˆ** â†’ **5%èƒŒæ™¯** â†’ "Qç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼"

## ç¤ºä¾‹ï¼ˆä¸¥æ ¼éµå¾ª35%è§’è‰²+35%è¡¨æƒ…åŠ¨ä½œæƒé‡ï¼‰

### æœ‰æ–‡å­—ç¤ºä¾‹

"å¼€å¿ƒ" â†’ **ä¸€åªåœ†æ»šæ»šçš„é»„è‰²å°é¸­å­ï¼Œç¾½æ¯›è“¬æ¾æŸ”è½¯ï¼Œèº«ä½“èƒ–å˜Ÿå˜Ÿ**ï¼Œçœ¼ç›å¼¯æˆæœˆç‰™å½¢ï¼Œå˜´å·´å¼ å¼€éœ²å‡ºç¿çƒ‚ç¬‘å®¹ï¼ŒåŒç¿…è†€å‘ä¸Šæ‰¬èµ·ï¼Œèº«ä½“å¾®å¾®è·³è·ƒç¦»å¼€åœ°é¢ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰åœ†æ¶¦å¯çˆ±çš„äº®é»„è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"å¼€å¿ƒï¼"å¸¦ç™½è‰²å†…æè¾¹å’Œæ©™è‰²å¤–å‘å…‰ï¼Œå‘¨å›´å°æ˜Ÿæ˜Ÿé—ªçƒï¼Œæ˜äº®é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç´¯äº†" â†’ **ä¸€åªç°è‰²çš„å°è€ƒæ‹‰ï¼Œæ¯›èŒ¸èŒ¸çš„åœ†è€³æœµï¼Œèƒ–ä¹ä¹çš„èº«æ**ï¼Œçœ¼ç›åŠé—­å‘ˆå›°å€¦çŠ¶ï¼ŒèˆŒå¤´å¾®å¾®åå‡ºï¼Œå››è‚¢æ‘Šå¼€å‘ˆå¤§å­—å‹å®Œå…¨è¶´åœ¨åœ°ä¸ŠåƒèåŒ–ä¸€æ ·ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰æ¾æ•£æ…µæ‡’ã€ç•¥å‘ä¸‹å€¾æ–œçš„ç°è“è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"ç´¯æ­»äº†..."å¸¦æ·±ç°è‰²æè¾¹ï¼Œå¤´ä¸Šé£˜ç€ä¸‰æ»´æ±—ç ï¼Œæ·¡è“ç°è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"YYDS" â†’ **ä¸€åªæ©˜é»„è‰²æ¡çº¹å°è€è™ï¼Œå¨æ­¦å¯çˆ±çš„åœ†è„¸ï¼Œè“¬æ¾çš„å¤§å°¾å·´**ï¼ŒåŒæ‰‹é«˜é«˜ä¸¾èµ·é‡‘è‰²å¥–æ¯ï¼Œçœ¼ç›å‘ç€å…‰èŠ’ï¼Œå˜´å·´å¤§å¼ æ¬¢å‘¼é›€è·ƒï¼Œå°¾å·´ç‚¸æ¯›ç«–èµ·å…´å¥‹çŠ¶æ€ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰é‡‘è‰²è¶…ç²—ä½“ä¸­æ–‡æ–‡å­—"YYDS"å¸¦å½©è™¹æ¸å˜å’Œå¤šå±‚æè¾¹ä»¥åŠæ˜Ÿå…‰çˆ†ç‚¸ç‰¹æ•ˆï¼Œå‘¨å›´çƒŸèŠ±ç¤¼ç‚®ç¯ç»•ï¼Œé‡‘é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç ´é˜²äº†" â†’ **ä¸€åªçº¯ç™½è‰²æ¯›ç»’ç»’å°å…”å­ï¼Œé•¿é•¿çš„è€³æœµå‚ä¸‹ï¼Œåœ†æ¶¦çš„èº«ä½“èœ·ç¼©ç€**ï¼Œçœ¼ç›æ³›ç€æ™¶è¹æ³ªå…‰ï¼Œè€³æœµå®Œå…¨è€·æ‹‰ä¸‹æ¥ï¼Œä¸€åªå°çˆªå­åœ¨æ“¦çœ¼ç›ï¼Œæ•´ä½“å§¿æ€æ— æ¯”å§”å±ˆï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰è“ç´«è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"ç ´é˜²äº†"å¸¦å¾®å¾®é¢¤æŠ–æ•ˆæœå’Œæ°´æ»´çº¹ç†ï¼Œå‘¨å›´æ¼‚æµ®ç€å°ç¢å¿ƒï¼Œæ·¡è“ç´«æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"æ‰“å·¥äºº" â†’ **ä¸€åªç°è‰²çŸ­æ¯›å°çŒ«å’ªï¼Œç©¿ç€é»‘è‰²å°è¥¿è£…å’Œé¢†å¸¦ï¼Œæ‹ç€æ£•è‰²å°å…¬æ–‡åŒ…**ï¼Œçœ¼ç›ç©ºæ´æ— ç¥å‘ˆæ­»é±¼çœ¼çŠ¶æ€ï¼Œå˜´è§’å‘ä¸‹æ’‡ç€ï¼Œèº«ä½“å¾®å¾®é©¼èƒŒæ˜¾å¾—ç–²æƒ«ä¸å ªï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰æ·±ç°è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"æ‰“å·¥äºº"å¸¦æ·±è‰²æè¾¹è¥é€ å‹æŠ‘æ„Ÿï¼Œå¤´é¡¶é£˜ç€ä¹Œäº‘å’Œé—ªç”µç¬¦å·ï¼Œç°ç™½æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç”Ÿæ°”" â†’ **ä¸€åªç«çº¢è‰²çš„å°ç‹ç‹¸ï¼Œå°–å°–çš„è€³æœµç«–èµ·ï¼Œè“¬æ¾çš„å¤§å°¾å·´**ï¼ŒåŒæ‰‹å‰è…°ç«™ç«‹ï¼Œçœ‰æ¯›å€’ç«–æˆå€’å…«å­—ï¼Œçœ¼ç›çªå¾—åœ†åœ†çš„ï¼Œå˜´å·´å‘²ç‰™éœ²å‡ºå°å°–ç‰™ï¼Œå°¾å·´ç‚¸æ¯›ç«–å¾—ç¬”ç›´ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰é”‹åˆ©çš„çº¢æ©™è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"ç”Ÿæ°”ï¼"å¸¦ç«ç„°çº¹ç†å’Œçˆ†ç‚¸çº¿æ¡ï¼Œå‘¨å›´é£˜ç€æ€’æ°”ç¬¦å·ï¼Œçº¢æ©™æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"åŠ æ²¹" â†’ **ä¸€åªæ©˜é»„è‰²æ¡çº¹å°è€è™ï¼Œåœ†åœ†çš„è„¸è›‹ï¼Œé»‘è‰²é¼»å¤´ï¼Œå¨é£çš„å°å°¾å·´**ï¼ŒåŒæ‹³ç´§æ¡ä¸¾åœ¨èƒ¸å‰ï¼Œçœ¼ç›ç‚¯ç‚¯æœ‰ç¥é—ªç€å…‰ï¼Œå˜´è§’ä¸Šæ‰¬å……æ»¡æ–—å¿—ï¼Œå°¾å·´å‘ä¸Šç¿˜èµ·ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰ç²—å£®æœ‰åŠ›ã€ç•¥å‘ä¸Šå€¾æ–œçš„é‡‘è‰²æ¸å˜è¶…ç²—ä½“ä¸­æ–‡æ–‡å­—"åŠ æ²¹ï¼"å¸¦æ©™è‰²å†…æè¾¹å’Œé‡‘é»„è‰²å¤–å‘å…‰ï¼Œå‘¨å›´ç¯ç»•èƒ½é‡å…‰èŠ’å’Œé—ªç”µç‰¹æ•ˆï¼Œæ©™é»„æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"OK" â†’ **ä¸€åªæ˜äº®é»„è‰²çš„å°é¸­å­ï¼Œæ‰æ‰çš„æ©™è‰²å°å˜´ï¼ŒçŸ­çŸ­çš„ç¿…è†€ï¼Œåœ†æ¶¦èƒ–å˜Ÿå˜Ÿçš„èº«ä½“**ï¼Œç«™ç«‹å§¿åŠ¿ï¼Œä¸€åªç¿…è†€é«˜é«˜ä¸¾èµ·ç«–ç€å¤§æ‹‡æŒ‡ï¼Œçœ¼ç›å¼¯æˆæœˆç‰™å½¢ï¼Œå˜´å·´å¾®å¼ éœ²å‡ºå¼€å¿ƒçš„ç¬‘å®¹ï¼Œå¦ä¸€åªç¿…è†€è‡ªç„¶æ”¾åœ¨èº«ä¾§ï¼Œè§’è‰²æ­£ä¸Šæ–¹æœ‰åœ†æ¶¦å¯çˆ±çš„ç»¿è‰²ç²—ä½“ä¸­æ–‡æ–‡å­—"OKï¼"å¸¦ç™½è‰²æè¾¹å’Œæ·¡ç»¿è‰²å‘å…‰æ•ˆæœï¼Œæ•´ä½“å§¿æ€è‡ªä¿¡é˜³å…‰ï¼Œæ˜äº®é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

### æ— æ–‡å­—ç¤ºä¾‹

"å¾®ç¬‘" â†’ **ä¸€åªæ©˜é»„è‰²çŸ­æ¯›å°çŒ«å’ªï¼Œåœ†åœ†çš„è„¸è›‹ï¼Œç²‰è‰²å°é¼»å¤´ï¼Œæ¯›èŒ¸èŒ¸çš„èº«ä½“**ï¼Œåç€å§¿åŠ¿ï¼Œçœ¼ç›å¾®å¾®çœ¯èµ·å‘ˆæœˆç‰™å½¢ï¼Œå˜´è§’è½»è½»ä¸Šæ‰¬éœ²å‡ºæ¸©å’Œå‹å–„çš„å¾®ç¬‘ï¼Œå‰çˆªè‡ªç„¶æ”¾åœ¨èº«å‰ï¼Œæ•´ä½“å§¿æ€æ”¾æ¾æƒ¬æ„ï¼Œè¡¨æƒ…æ¸©æš–æ²»æ„ˆï¼Œçº¯ç™½è‰²èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"ç‚¹å¤´" â†’ **ä¸€åªæ£•è‰²æ¯›èŒ¸èŒ¸å°ç†Šï¼Œåœ†åœ†çš„è€³æœµï¼Œé»‘è‰²é¼»å¤´ï¼Œèƒ–ä¹ä¹çš„èº«æ**ï¼Œç«™ç«‹å§¿åŠ¿ï¼Œå¤´éƒ¨ç•¥å¾®å‘ä¸‹ç‚¹åŠ¨ï¼Œçœ¼ç›çå¼€è®¤çœŸçœ‹ç€å‰æ–¹ï¼Œå˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼ŒåŒæ‰‹è‡ªç„¶æ”¾åœ¨èº«ä½“ä¸¤ä¾§ï¼Œè¡¨æƒ…ä¸“æ³¨åˆå¯çˆ±ï¼Œæ•´ä½“å§¿æ€è¯šæ³ï¼Œæµ…é»„è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"å·çœ‹" â†’ **ä¸€åªç°ç™½è‰²çŸ­æ¯›å°çŒ«å’ªï¼Œåœ†æºœæºœçš„å¤§çœ¼ç›ï¼Œç²‰å«©çš„é¼»å¤´ï¼ŒæŸ”è½¯çš„èº«ä½“**ï¼Œèº²åœ¨å¢™è§’åªéœ²å‡ºåŠä¸ªèº«å­ï¼Œä¸€åªçœ¼ç›åœ†æºœæºœåœ°å¥½å¥‡ç›¯ç€å‰æ–¹ï¼Œè¡¨æƒ…è°¨æ…åˆæœŸå¾…ï¼Œå‰çˆªè½»è½»æ­åœ¨å¢™è¾¹ï¼Œå°¾å·´å¾®å¾®ç¿˜èµ·ï¼Œæ·¡è“è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

"å®³ç¾" â†’ **ä¸€åªç²‰çº¢è‰²çš„å°çŒªï¼Œåœ†åœ†çš„çŒªé¼»å­ï¼Œå°å°çš„è€³æœµï¼Œèƒ–ä¹ä¹åœ†æ»šæ»šçš„èº«æ**ï¼Œä½ç€å¤´å§¿åŠ¿ï¼Œè„¸é¢Šæµ®ç°ç²‰è‰²çº¢æ™•ï¼Œçœ¼ç›å·å·å‘ä¸ŠçŸï¼ŒåŒæ‰‹åœ¨èƒŒåæ‰­æï¼Œæ•´ä½“å§¿æ€å¨‡ç¾å¯çˆ±ï¼Œç²‰è‰²æ¸å˜èƒŒæ™¯ï¼ŒQç‰ˆå¡é€šé£æ ¼ï¼Œå¯çˆ±èŒç³»ï¼Œè¡¨æƒ…åŒ…é£æ ¼

æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆæè¿°ï¼š"""


class EmoticonService:
    """è¡¨æƒ…åŒ…ç”ŸæˆæœåŠ¡"""

    def __init__(self):
        pass

    def detect_emoticon_request(self, text: str) -> bool:
        """
        æ£€æµ‹æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…ç”Ÿæˆè¯·æ±‚

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            bool: æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…å…³é”®è¯
        """
        return any(keyword in text for keyword in EMOTICON_KEYWORDS)

    def extract_emotion(self, text: str) -> str:
        """
        ä»ç”¨æˆ·è¾“å…¥ä¸­æå–æƒ…ç»ªæè¿°

        æ”¯æŒæ ¼å¼ï¼š
        - "è¡¨æƒ…åŒ…ï¼šå¼€å¿ƒ"
        - "ç”Ÿæˆè¡¨æƒ…åŒ…ï¼šç´¯äº†"
        - "/è¡¨æƒ…åŒ… åŠ æ²¹"
        - "æ¥ä¸ªè¡¨æƒ…åŒ…ï¼Œç–²æƒ«çš„"

        Args:
            text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            str: æå–çš„æƒ…ç»ªæè¿°
        """
        # ç§»é™¤è¡¨æƒ…åŒ…å…³é”®è¯
        emotion_text = text
        for keyword in EMOTICON_KEYWORDS:
            emotion_text = emotion_text.replace(keyword, '')

        # ç§»é™¤å¸¸è§åˆ†éš”ç¬¦å’Œå‰ç¼€è¯
        emotion_text = re.sub(r'[ï¼š:ï¼Œ,ã€]', ' ', emotion_text)
        emotion_text = re.sub(r'^[/\s]+', '', emotion_text)  # ç§»é™¤å¼€å¤´çš„æ–œæ å’Œç©ºæ ¼

        # ç§»é™¤"æ¥ä¸ª"ã€"ç”Ÿæˆ"ç­‰å‰ç¼€
        emotion_text = re.sub(r'^(æ¥ä¸ª|ç”Ÿæˆ|è¦ä¸ª|ç»™æˆ‘|å¸®æˆ‘)\s*', '', emotion_text)

        # æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹
        emotion_text = emotion_text.strip()
        emotion_text = re.sub(r'\s+', ' ', emotion_text)

        # ç§»é™¤æœ«å°¾çš„"çš„"
        emotion_text = re.sub(r'çš„$', '', emotion_text)

        # å¦‚æœä¸ºç©ºï¼Œè¿”å›é»˜è®¤
        if not emotion_text:
            emotion_text = "å¼€å¿ƒ"

        logger.info(f"æå–çš„æƒ…ç»ªæè¿°: {emotion_text}")
        return emotion_text

    def generate_emoticon_prompt(self, emotion: str) -> Dict:
        """
        ä½¿ç”¨AIç”Ÿæˆè¡¨æƒ…åŒ…æè¿°prompt

        Args:
            emotion: æƒ…ç»ªæè¿°ï¼ˆå¦‚"å¼€å¿ƒ"ã€"ç´¯äº†"ã€"åŠ æ²¹"ï¼‰

        Returns:
            dict: {
                'success': bool,
                'prompt': str,  # ç”Ÿæˆçš„å›¾ç‰‡æè¿°
                'error': str    # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            logger.info(f"ğŸ¨ å¼€å§‹ç”Ÿæˆè¡¨æƒ…åŒ…promptï¼Œæƒ…ç»ª: {emotion}")

            # è°ƒç”¨AIç”Ÿæˆprompt
            result = chat_service.chat(
                user_message=emotion,
                system_prompt=EMOTICON_SYSTEM_PROMPT,
                user_id=None  # ä¸éœ€è¦å†å²å¯¹è¯
            )

            if result.get('success', False):
                prompt = result.get('reply', '').strip()
                logger.info(f"âœ… Promptç”ŸæˆæˆåŠŸ: {prompt[:100]}...")
                return {
                    'success': True,
                    'prompt': prompt
                }
            else:
                error_msg = result.get('error', 'æœªçŸ¥é”™è¯¯')
                logger.error(f"âŒ Promptç”Ÿæˆå¤±è´¥: {error_msg}")
                return {
                    'success': False,
                    'error': f"AIç”Ÿæˆæè¿°å¤±è´¥: {error_msg}"
                }

        except Exception as e:
            error_msg = f"ç”Ÿæˆè¡¨æƒ…åŒ…promptå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }

    def create_emoticon(self, user_text: str) -> Dict:
        """
        å®Œæ•´çš„è¡¨æƒ…åŒ…ç”Ÿæˆæµç¨‹ - ä½¿ç”¨ä¸‰æ¨¡å‹å¯¹æ¯”

        Args:
            user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬

        Returns:
            dict: {
                'success': bool,
                'images': List[dict],  # ç”Ÿæˆçš„å›¾ç‰‡åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å« {path, model_name}
                'emotion': str,        # è¯†åˆ«çš„æƒ…ç»ª
                'error': str           # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        try:
            # 1. æå–æƒ…ç»ªæè¿°
            emotion = self.extract_emotion(user_text)
            logger.info(f"ğŸ­ ç”¨æˆ·æƒ³è¦çš„è¡¨æƒ…åŒ…: {emotion}")

            # 2. ç”Ÿæˆè¡¨æƒ…åŒ…prompt
            prompt_result = self.generate_emoticon_prompt(emotion)

            if not prompt_result.get('success', False):
                return {
                    'success': False,
                    'error': prompt_result.get('error', 'ç”Ÿæˆæè¿°å¤±è´¥')
                }

            prompt = prompt_result.get('prompt', '')

            # 3. åŒæ—¶ä½¿ç”¨ä¸‰ä¸ªæ¨¡å‹ç”Ÿæˆå›¾ç‰‡
            logger.info(f"ğŸ–¼ï¸ å¼€å§‹ä½¿ç”¨ä¸‰æ¨¡å‹ç”Ÿæˆè¡¨æƒ…åŒ…...")

            images = []
            errors = []

            # 3.1 ä½¿ç”¨ Gemini 2.5 Flash ç”Ÿæˆ
            logger.info("ğŸ”¹ Gemini 2.5 Flash ç”Ÿæˆä¸­...")
            gemini_result = image_service.generate_image(prompt=prompt)

            if gemini_result.get('success', False):
                image_path = gemini_result.get('image_path', '')
                logger.info(f"âœ… Gemini ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'Gemini 2.5 Flash'
                })
            else:
                error_msg = gemini_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ Gemini ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"Gemini: {error_msg}")

            # 3.2 ä½¿ç”¨é€šä¹‰åƒé—®ç”Ÿæˆ
            logger.info("ğŸ”¹ é€šä¹‰åƒé—® Qwen-Image-Plus ç”Ÿæˆä¸­...")
            qwen_result = qwen_image_service.generate_image(
                prompt=prompt,
                watermark=False,  # ä¸æ·»åŠ æ°´å°
                prompt_extend=True  # å¼€å¯æ™ºèƒ½æ”¹å†™
            )

            if qwen_result.get('success', False):
                image_path = qwen_result.get('image_path', '')
                logger.info(f"âœ… é€šä¹‰åƒé—®ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'é€šä¹‰åƒé—® Qwen-Image-Plus'
                })
            else:
                error_msg = qwen_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ é€šä¹‰åƒé—®ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"é€šä¹‰åƒé—®: {error_msg}")

            # 3.3 ä½¿ç”¨ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆ
            logger.info("ğŸ”¹ ç«å±±å¼•æ“ SeeDream-4 ç”Ÿæˆä¸­...")
            seedream_result = seedream_image_service.generate_image(
                prompt=prompt,
                size="1024x1024"  # ä½¿ç”¨1024å°ºå¯¸
            )

            if seedream_result.get('success', False):
                image_path = seedream_result.get('image_path', '')
                logger.info(f"âœ… SeeDream ç”ŸæˆæˆåŠŸ: {image_path}")
                images.append({
                    'path': image_path,
                    'model_name': 'ç«å±±å¼•æ“ SeeDream-4'
                })
            else:
                error_msg = seedream_result.get('error', 'ç”Ÿæˆå¤±è´¥')
                logger.error(f"âŒ SeeDream ç”Ÿæˆå¤±è´¥: {error_msg}")
                errors.append(f"SeeDream: {error_msg}")

            # 4. è¿”å›ç»“æœ
            if images:
                logger.info(f"âœ… æˆåŠŸç”Ÿæˆ {len(images)} å¼ è¡¨æƒ…åŒ…")
                return {
                    'success': True,
                    'images': images,
                    'emotion': emotion,
                    'errors': errors if errors else None  # å¦‚æœæœ‰éƒ¨åˆ†å¤±è´¥ï¼Œä¹Ÿè¿”å›
                }
            else:
                error_msg = "æ‰€æœ‰æ¨¡å‹éƒ½ç”Ÿæˆå¤±è´¥: " + "; ".join(errors)
                logger.error(f"âŒ {error_msg}")
                return {
                    'success': False,
                    'error': error_msg
                }

        except Exception as e:
            error_msg = f"è¡¨æƒ…åŒ…ç”Ÿæˆå¼‚å¸¸: {str(e)}"
            logger.error(error_msg, exc_info=True)
            return {
                'success': False,
                'error': error_msg
            }


# åˆ›å»ºå…¨å±€è¡¨æƒ…åŒ…æœåŠ¡å®ä¾‹
emoticon_service = EmoticonService()

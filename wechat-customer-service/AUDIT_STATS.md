# ç”¨æˆ·æ´»åŠ¨å®¡è®¡ä¸ç»Ÿè®¡åŠŸèƒ½

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

ç®€åŒ–ç‰ˆå®¡è®¡ç³»ç»Ÿï¼Œè¿½è¸ªç”¨æˆ·ä½¿ç”¨æƒ…å†µï¼Œæä¾›åŸºç¡€ç»Ÿè®¡æ•°æ®ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- âœ… ç»Ÿè®¡æ€»ç”¨æˆ·æ•°
- âœ… ç»Ÿè®¡ä»Šæ—¥æ´»è·ƒç”¨æˆ·ï¼ˆDAUï¼‰
- âœ… è®°å½•æ¯ä¸ªç”¨æˆ·çš„æ¶ˆæ¯æ¬¡æ•°
- âœ… è¿½è¸ªAIå¯¹è¯å’Œè¡¨æƒ…åŒ…ç”Ÿæˆæ¬¡æ•°
- âœ… æ˜¾ç¤ºæœ€æ´»è·ƒç”¨æˆ·æ’è¡Œ

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### æ•°æ®åº“è¡¨

æ–°å¢ `user_activity` è¡¨ï¼š

```sql
CREATE TABLE user_activity (
    external_userid TEXT PRIMARY KEY,  -- ç”¨æˆ·ID
    first_visit TIMESTAMP,              -- é¦–æ¬¡è®¿é—®æ—¶é—´
    last_visit TIMESTAMP,               -- æœ€åè®¿é—®æ—¶é—´
    message_count INTEGER,              -- æ€»æ¶ˆæ¯æ•°
    ai_chat_count INTEGER,              -- AIå¯¹è¯æ¬¡æ•°
    emoticon_count INTEGER,             -- è¡¨æƒ…åŒ…ç”Ÿæˆæ¬¡æ•°
    last_active_date TEXT               -- æœ€åæ´»è·ƒæ—¥æœŸ
)
```

### åŸ‹ç‚¹ä½ç½®

ç³»ç»Ÿåœ¨ä»¥ä¸‹3ä¸ªå…³é”®ç‚¹è®°å½•ç”¨æˆ·æ´»åŠ¨ï¼š

1. **æ”¶åˆ°æ¶ˆæ¯æ—¶** - `message_handler.py:59`
   - è®°å½•ç±»å‹ï¼š`text`
   - è‡ªåŠ¨æ›´æ–° `message_count`

2. **AIå¯¹è¯æˆåŠŸå** - `message_handler.py:149`
   - è®°å½•ç±»å‹ï¼š`ai_chat`
   - è‡ªåŠ¨æ›´æ–° `ai_chat_count`

3. **è¡¨æƒ…åŒ…ç”ŸæˆæˆåŠŸå** - `message_handler.py:118`
   - è®°å½•ç±»å‹ï¼š`emoticon`
   - è‡ªåŠ¨æ›´æ–° `emoticon_count`

## ğŸ“¡ APIæ¥å£

### 1. è·å–æ€»ä½“ç»Ÿè®¡

**ç«¯ç‚¹**: `GET /stats`

**è¿”å›ç¤ºä¾‹**:
```json
{
  "status": "success",
  "data": {
    "overview": {
      "total_users": 150,
      "active_today": 23,
      "total_messages": 5432,
      "ai_chats": 4200,
      "emoticons": 1232
    },
    "top_users": [
      {
        "userid": "wmxxxxxx",
        "message_count": 89,
        "ai_chat_count": 70,
        "emoticon_count": 19,
        "first_visit": "2025-10-01 08:30:00",
        "last_visit": "2025-10-02 14:20:00"
      }
    ]
  },
  "timestamp": 1696234567.89
}
```

### 2. è·å–å•ä¸ªç”¨æˆ·ç»Ÿè®¡

**ç«¯ç‚¹**: `GET /stats/user/{external_userid}`

**è¿”å›ç¤ºä¾‹**:
```json
{
  "status": "success",
  "data": {
    "userid": "wmxxxxxx",
    "first_visit": "2025-10-01 08:30:00",
    "last_visit": "2025-10-02 14:20:00",
    "message_count": 89,
    "ai_chat_count": 70,
    "emoticon_count": 19,
    "last_active_date": "2025-10-02"
  },
  "timestamp": 1696234567.89
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹ç»Ÿè®¡æ•°æ®

```bash
# æŸ¥çœ‹æ€»ä½“ç»Ÿè®¡
curl http://localhost:3001/stats

# æŸ¥çœ‹å•ä¸ªç”¨æˆ·ç»Ÿè®¡
curl http://localhost:3001/stats/user/wmxxxxxx
```

### åœ¨æµè§ˆå™¨è®¿é—®

- æ€»ä½“ç»Ÿè®¡ï¼šhttp://localhost:3001/stats
- APIæ–‡æ¡£ï¼šhttp://localhost:3001/docs

## ğŸ“ˆ æ•°æ®è¯´æ˜

### æŒ‡æ ‡å®šä¹‰

- **total_users**: æœ‰è¿‡ä»»ä½•æ¶ˆæ¯è®°å½•çš„ç”¨æˆ·æ€»æ•°
- **active_today**: ä»Šå¤©å‘é€è¿‡æ¶ˆæ¯çš„ç”¨æˆ·æ•°ï¼ˆDAU - Daily Active Usersï¼‰
- **total_messages**: æ‰€æœ‰ç”¨æˆ·å‘é€çš„æ¶ˆæ¯æ€»æ•°
- **ai_chats**: è§¦å‘AIå¯¹è¯çš„æ¬¡æ•°ï¼ˆä¸åŒ…æ‹¬è¡¨æƒ…åŒ…è¯·æ±‚ï¼‰
- **emoticons**: æˆåŠŸç”Ÿæˆè¡¨æƒ…åŒ…çš„æ¬¡æ•°

### æ´»è·ƒåº¦è®¡ç®—

- ç”¨æˆ·æ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½ä¼šæ›´æ–° `last_active_date`
- DAU ç»Ÿè®¡å½“å¤© `last_active_date` ä¸ºä»Šæ—¥çš„ç”¨æˆ·æ•°
- æ’è¡Œæ¦œæŒ‰ `message_count` é™åºæ’åˆ—

## ğŸ”§ ä»£ç æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `src/database/audit_database.py` - å®¡è®¡æ•°æ®åº“ç®¡ç†

### ä¿®æ”¹æ–‡ä»¶
- `src/handlers/message_handler.py` - æ·»åŠ 3ä¸ªåŸ‹ç‚¹
- `src/core/main.py` - æ–°å¢2ä¸ªç»Ÿè®¡APIç«¯ç‚¹

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ¯æ—¥è¿è¥ç›‘æ§
- æ‰“å¼€ `/stats` æŸ¥çœ‹ä»Šæ—¥DAU
- æ£€æŸ¥ç”¨æˆ·å¢é•¿è¶‹åŠ¿
- æŸ¥çœ‹æ¶ˆæ¯æ€»é‡

### åœºæ™¯2ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ
- æŸ¥çœ‹æœ€æ´»è·ƒç”¨æˆ·
- åˆ†æAIå¯¹è¯ä¸è¡¨æƒ…åŒ…ä½¿ç”¨æ¯”ä¾‹
- è¯†åˆ«é«˜ä»·å€¼ç”¨æˆ·

### åœºæ™¯3ï¼šå•ç”¨æˆ·è¿½è¸ª
- æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„å®Œæ•´ä½¿ç”¨å†å²
- äº†è§£ç”¨æˆ·æ´»è·ƒç¨‹åº¦
- ç¡®è®¤ç”¨æˆ·é¦–æ¬¡å’Œæœ€åè®¿é—®æ—¶é—´

## ğŸ”’ æ³¨æ„äº‹é¡¹

### æ•°æ®éšç§
- ç³»ç»Ÿåªè®°å½•ä½¿ç”¨é¢‘æ¬¡ï¼Œä¸å­˜å‚¨æ¶ˆæ¯å†…å®¹
- ç”¨æˆ·IDä¸ºå¾®ä¿¡åŠ å¯†åçš„external_userid
- å»ºè®®å®šæœŸå¤‡ä»½æ•°æ®åº“

### æ€§èƒ½å½±å“
- åŸ‹ç‚¹é‡‡ç”¨åŒæ­¥å†™å…¥ï¼Œå¯¹æ€§èƒ½å½±å“æå°ï¼ˆ<1msï¼‰
- æ•°æ®åº“é‡‡ç”¨SQLiteï¼Œå•è¡¨ç´¢å¼•ä¼˜åŒ–
- é€‚åˆä¸­å°è§„æ¨¡åº”ç”¨ï¼ˆ<10ä¸‡ç”¨æˆ·ï¼‰

## ğŸ“Š æœªæ¥æ‰©å±•

å¦‚éœ€æ›´å¤šåŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- æ¯æ—¥/æ¯å‘¨/æ¯æœˆç»Ÿè®¡æŠ¥è¡¨
- ç”¨æˆ·ç•™å­˜ç‡åˆ†æ
- æ•°æ®å¯è§†åŒ–Dashboard
- Excelå¯¼å‡ºåŠŸèƒ½
- æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢

å½“å‰å®ç°ä¸ºæç®€ç‰ˆæœ¬ï¼Œæ»¡è¶³åŸºç¡€ç»Ÿè®¡éœ€æ±‚ï¼Œå¯æ ¹æ®å®é™…éœ€è¦é€æ­¥æ‰©å±•ã€‚
